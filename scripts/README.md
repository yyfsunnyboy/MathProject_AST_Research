# Math Master 自動化工具箱 (Scripts)

本目錄存放用於系統維護、資料填充與自動化處理的 Python 腳本。

## ⚠️ 執行前準備
所有腳本皆需在專案 **虛擬環境 (venv)** 下執行,並確保專案根目錄已有 `.env` 設定檔(需包含 `GEMINI_API_KEY` 與資料庫設定)。

**啟動虛擬環境指令:**
```bash
# Windows
..\venv\Scripts\activate

# Mac/Linux
source ../venv/bin/activate
```

## 1. 技能提示詞生成器 (enrich_skills.py)

### 📋 功能描述
此腳本會掃描資料庫中的 `skills_info` 表,找出尚未設定 `suggested_prompt` (AI 推薦提問) 的技能。 它會自動讀取該技能的「課本例題」作為上下文,呼叫 Google Gemini 模型生成符合 **「功文數學 (Kumon)」** 風格的引導語。

**生成內容特色:**
*   **Prompt 1 (觀察例題)**:引導學生觀察例題規律。
*   **Prompt 2 (步驟提示)**:提示解題的第一個具體動作。
*   **Prompt 3 (自我檢查)**:提醒常見的粗心錯誤。

**風格限制**:繁體中文、極度精簡(約 20 字以內)、不講大道理。

### ⏱ 使用時機
*   **新資料匯入後**:當 Text Book Processor 解析完新課本,產生了新技能但欄位為空時。
*   **資料庫遷移後**:當系統架構升級,舊有技能缺少新欄位資料時。
*   **批次更新**:若想更換 AI 引導風格,可先在資料庫清空該欄位,再執行此腳本重新生成。

### 🚀 執行方式
請在 **專案根目錄** 下執行:

```bash
python scripts/enrich_skills.py
```
*(注意:請勿在 scripts 資料夾內直接執行,以免發生 Module Import Error)*

### ✅ 完成後的視角效果
*   **終端機**:會顯示處理進度條 (Progress Bar) 與成功/失敗狀態。
*   **後台管理**:進入 `/admin/skills` 點擊「編輯」,原本空白的「推薦提問」欄位將自動填入 AI 生成的引導語。
*   **前端練習**:學生在練習該技能時,介面上會出現這三個引導按鈕。

---

## 2. 技能檔案同步工具 (`sync_skills_files.py`)

### 📋 功能描述
此腳本用於同步 **資料庫 (`skills_info`)** 與 **檔案系統 (`skills/*.py`)** 的狀態,確保兩者一致。
為了降低批量操作的風險,腳本內建了強大的 **「分層篩選 (Layered Filtering)」** 與 **「集合運算比對」** 機制。

**核心功能:**
* **補齊缺失 (Generate Missing)**:資料庫有 ID 但沒檔案 $\rightarrow$ 自動呼叫 AI 生成程式碼。
* **清理孤兒 (Delete Orphaned)**:資料夾有檔案但資料庫無 ID $\rightarrow$ 經確認後自動刪除。
* **互動式篩選 (Interactive Filtering)**:支援依序選擇 **課綱 > 年級 > 冊次 > 章節**,可精準鎖定特定範圍(例如只重生成「高一數學第一章」的檔案)。
* **安全保護 (Safety)**:
    * **白名單機制**:強制保護核心檔案 (如 `Example_Program.py`, `base_skill.py`) 不被刪除。
    * **全域刪除檢查**:刪除檔案前會檢查全域資料庫,確保該 ID 真的完全廢棄,避免因篩選範圍不同而誤刪。

### ⏱ 使用時機
1.  **大量匯入後**:當資料庫新增了大量技能 (例如剛解析完新課本),需要一次性生成對應的 Python 檔時。
2.  **清理廢棄技能**:當從資料庫刪除舊技能後,用來清除硬碟中殘留的 `.py` 檔案。
3.  **修復特定章節**:當發現某個章節的程式碼都有問題,可手動刪除該章節檔案後,利用此腳本針對該章節重新生成。

### 🚀 執行方式
請在 **專案根目錄** 下執行:
```bash
python scripts/sync_skills_files.py
```

**操作流程範例:**
1. 腳本詢問 「請選擇【課綱】」 $\rightarrow$ 輸入 1 (普高)。
2. 腳本詢問 「請選擇【年級】」 $\rightarrow$ 輸入 0 (全選,不分年級)。
3. 腳本分析後顯示:
   - 範圍內缺失檔案 (需生成): 5
   - 全域孤兒檔案 (需刪除): 2
4. 輸入 `y` 確認執行。

### ✅ 執行結果效果
*   **自動生成**:缺失的 `.py` 檔案會逐一被 AI 寫入 `skills/` 資料夾,並顯示成功/失敗統計。
*   **自動清理**:不在資料庫中的廢棄 `.py` 檔案將被移除。
*   **進度顯示**:使用 `tqdm` 顯示即時進度條。

---

## 3. 前置技能自動建構工具 (`auto_build_prerequisites.py`)

### 📋 功能描述
此腳本透過 **AI 智能分析** 自動建立技能之間的「前置技能 (Prerequisites)」關聯,構建完整的數學知識圖譜。它會根據技能的課程順序、描述內容與課本例題,智能判斷每個技能所需的基礎知識,並自動寫入資料庫的多對多關聯表。

**核心功能:**
*   **階層式篩選 (Hierarchical Filtering)**:支援依序選擇 **課綱 > 年級 > 冊次 > 章節**,精準鎖定處理範圍。
*   **智能候選池 (Smart Candidate Pool)**:
    *   **跨階段邏輯**:高中技能 (gh_) 可自動納入所有國中技能 (jh_) 作為候選。
    *   **同階段邏輯**:依照 `order_index` 排序,只選擇「順序在前」的技能作為候選。
*   **AI 上下文分析**:結合技能描述與課本例題 (TextbookExample),讓 AI 更精準判斷真正需要的前置知識。
*   **數量限制**:每個技能最多選出 **5 個最關鍵** 的前置技能,避免關聯過度複雜。
*   **雙模式操作**:
    *   **Safe Mode (安全模式)**:僅處理目前「沒有」前置技能的項目,保護已有資料。
    *   **Power Mode (強制模式)**:重新分析並「覆蓋」現有的前置技能,適合全面更新。

**AI 分析邏輯:**
1.  **需求分析**:解析目標技能的描述與例題,提取所需的數學概念 (例如:解一元二次方程式需要「因式分解」與「平方根」)。
2.  **候選比對**:從候選池中找出涵蓋這些概念的技能。
3.  **階層優先**:若目標是高中技能,優先檢查國中候選;嚴格篩選「直接必要」的前置技能。

### ⏱ 使用時機
*   **新課本匯入後**:當 Text Book Processor 解析完新課本,產生大量新技能時,一次性建立完整的知識圖譜。
*   **課程架構調整**:當技能的 `order_index` 或課程分類被重新調整後,需要重新計算前置關聯。
*   **知識圖譜優化**:定期執行 Power Mode,利用最新的 AI 模型重新分析,提升關聯準確度。
*   **特定章節修復**:當發現某個章節的前置技能設定有誤,可針對該章節重新建構。

### 🚀 執行方式
請在 **專案根目錄** 下執行:

```bash
python scripts/auto_build_prerequisites.py
```

**操作流程範例:**
1. 腳本詢問 「請選擇要處理的課綱 (Curriculum)」 $\rightarrow$ 輸入 1 (普高) 或 0 (全選)。
2. 腳本詢問 「請選擇年級 (Grade)」 $\rightarrow$ 輸入 1 (高一) 或 0 (全選)。
3. 腳本詢問 「請選擇冊別 (Volume)」 $\rightarrow$ 輸入 1 (第一冊) 或 0 (全選)。
4. 腳本詢問 「請選擇章節 (Chapter)」 $\rightarrow$ 輸入 1 (第一章) 或 0 (全選)。
5. 腳本顯示:「共篩選出 25 個目標技能待處理」。
6. 選擇操作模式:
   - 輸入 `1` (Safe Mode):僅處理目前沒有前置技能的項目。
   - 輸入 `2` (Power Mode):重新分析並覆蓋現有的前置技能。
7. 輸入 `y` 確認執行,開始 AI 分析。

### ✅ 完成後的視角效果
*   **終端機**:顯示 `tqdm` 進度條,即時追蹤分析進度與完成狀態。
*   **資料庫**:`skill_prerequisites` 多對多關聯表自動填入 AI 推薦的前置技能 ID。
*   **後台管理**:進入 `/admin/prerequisites` 頁面,可視覺化檢視與編輯每個技能的前置技能關聯圖。
*   **前端學習路徑**:學生在學習某技能時,系統可自動推薦「建議先學習」的基礎技能,構建個人化學習路徑。

**範例輸出:**
```
🚀 啟動前置技能自動建構工具 (Auto-Build Prerequisites)
========================================================
請選擇要處理的課綱 (Curriculum):
   [0] ALL (全部處理)
   [1] 普高
👉 請選擇 (輸入數字): 1

請選擇年級 (Grade):
   [0] ALL (全部處理)
   [1] 高一
   [2] 高二
👉 請選擇 (輸入數字): 0

📋 共篩選出 120 個目標技能待處理。

請選擇操作模式:
   [1] Safe Mode (安全模式): 僅處理目前「沒有」前置技能的項目
   [2] Power Mode (強制模式): 重新分析並「覆蓋」現有的前置技能
👉 請輸入 (預設 1): 1
是否開始執行 AI 分析? (y/n): y

📦 正在建立技能快取資料庫...

--- 開始分析 ---
分析進度: 100%|██████████████████████| 120/120 [05:30<00:00,  2.75s/it]

✅ 處理完成!所有關聯已寫入資料庫。
```
