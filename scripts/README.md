# Math Master 自動化工具箱 (Scripts)

本目錄存放用於系統維護、資料填充與自動化處理的 Python 腳本。

## ⚠️ 執行前準備
所有腳本皆需在專案 **虛擬環境 (venv)** 下執行，並確保專案根目錄已有 `.env` 設定檔（需包含 `GEMINI_API_KEY` 與資料庫設定）。

**啟動虛擬環境指令：**
```bash
# Windows
..\venv\Scripts\activate

# Mac/Linux
source ../venv/bin/activate
```

## 1. 技能提示詞生成器 (enrich_skills.py)

### 📋 功能描述
此腳本會掃描資料庫中的 `skills_info` 表，找出尚未設定 `suggested_prompt` (AI 推薦提問) 的技能。 它會自動讀取該技能的「課本例題」作為上下文，呼叫 Google Gemini 模型生成符合 **「功文數學 (Kumon)」** 風格的引導語。

**生成內容特色：**
*   **Prompt 1 (觀察例題)**：引導學生觀察例題規律。
*   **Prompt 2 (步驟提示)**：提示解題的第一個具體動作。
*   **Prompt 3 (自我檢查)**：提醒常見的粗心錯誤。

**風格限制**：繁體中文、極度精簡（約 20 字以內）、不講大道理。

### ⏱ 使用時機
*   **新資料匯入後**：當 Text Book Processor 解析完新課本，產生了新技能但欄位為空時。
*   **資料庫遷移後**：當系統架構升級，舊有技能缺少新欄位資料時。
*   **批次更新**：若想更換 AI 引導風格，可先在資料庫清空該欄位，再執行此腳本重新生成。

### 🚀 執行方式
請在 **專案根目錄** 下執行：

```bash
python scripts/enrich_skills.py
```
*(注意：請勿在 scripts 資料夾內直接執行，以免發生 Module Import Error)*

### ✅ 完成後的視角效果
*   **終端機**：會顯示處理進度條 (Progress Bar) 與成功/失敗狀態。
*   **後台管理**：進入 `/admin/skills` 點擊「編輯」，原本空白的「推薦提問」欄位將自動填入 AI 生成的引導語。
*   **前端練習**：學生在練習該技能時，介面上會出現這三個引導按鈕。

---

## 2. 技能檔案同步工具 (`sync_skills_files.py`)

### 📋 功能描述
此腳本用於同步 **資料庫 (`skills_info`)** 與 **檔案系統 (`skills/*.py`)** 的狀態，確保兩者一致。
為了降低批量操作的風險，腳本內建了強大的 **「分層篩選 (Layered Filtering)」** 與 **「集合運算比對」** 機制。

**核心功能：**
* **補齊缺失 (Generate Missing)**：資料庫有 ID 但沒檔案 $\rightarrow$ 自動呼叫 AI 生成程式碼。
* **清理孤兒 (Delete Orphaned)**：資料夾有檔案但資料庫無 ID $\rightarrow$ 經確認後自動刪除。
* **互動式篩選 (Interactive Filtering)**：支援依序選擇 **課綱 > 年級 > 冊次 > 章節**，可精準鎖定特定範圍（例如只重生成「高一數學第一章」的檔案）。
* **安全保護 (Safety)**：
    * **白名單機制**：強制保護核心檔案 (如 `Example_Program.py`, `base_skill.py`) 不被刪除。
    * **全域刪除檢查**：刪除檔案前會檢查全域資料庫，確保該 ID 真的完全廢棄，避免因篩選範圍不同而誤刪。

### ⏱ 使用時機
1.  **大量匯入後**：當資料庫新增了大量技能 (例如剛解析完新課本)，需要一次性生成對應的 Python 檔時。
2.  **清理廢棄技能**：當從資料庫刪除舊技能後，用來清除硬碟中殘留的 `.py` 檔案。
3.  **修復特定章節**：當發現某個章節的程式碼都有問題，可手動刪除該章節檔案後，利用此腳本針對該章節重新生成。

### 🚀 執行方式
請在 **專案根目錄** 下執行：
```bash
python scripts/sync_skills_files.py
```

**操作流程範例：**
1. 腳本詢問 「請選擇【課綱】」 $\rightarrow$ 輸入 1 (普高)。
2. 腳本詢問 「請選擇【年級】」 $\rightarrow$ 輸入 0 (全選，不分年級)。
3. 腳本分析後顯示：
   - 範圍內缺失檔案 (需生成): 5
   - 全域孤兒檔案 (需刪除): 2
4. 輸入 `y` 確認執行。

### ✅ 執行結果效果
*   **自動生成**：缺失的 `.py` 檔案會逐一被 AI 寫入 `skills/` 資料夾，並顯示成功/失敗統計。
*   **自動清理**：不在資料庫中的廢棄 `.py` 檔案將被移除。
*   **進度顯示**：使用 `tqdm` 顯示即時進度條。
