{% extends "base.html" %}
<!--
=============================================================================
模組名稱 (Module Name): templates/add_mistake.html
功能說明 (Description): 新增錯題頁面
後端呼叫 (Backend Call): core/routes/analysis.py -> add_mistake_page
版本資訊 (Version): V2.0
更新日期 (Date): 2026-01-13
維護團隊 (Maintainer): Math AI Project Team
=============================================================================
-->

{% block title %}手動新增錯題{% endblock %}

{% block styles %}
<style>
    .container {
        max-width: 800px;
        margin-top: 2rem;
    }
    #image-preview {
        max-width: 100%;
        max-height: 400px;
        border: 1px solid #ddd;
        margin-top: 1rem;
        display: none;
    }
    .form-label {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>手動新增錯題</h2>
        <a href="{{ url_for('core.mistake_notebook') }}" class="btn btn-secondary">返回錯題本</a>
    </div>

    <div class="card">
        <div class="card-body">
            <form id="add-mistake-form">
                <!-- Hidden field for image path -->
                <input type="hidden" id="exam_image_path" name="exam_image_path">

                <!-- File Upload -->
                <div class="mb-3">
                    <label for="image-upload-input" class="form-label">1. 上傳錯題圖片</label>
                    <input class="form-control" type="file" id="image-upload-input" accept="image/*">
                    <div id="upload-status" class="form-text"></div>
                    <img id="image-preview" src="#" alt="圖片預覽" />
                </div>

                <!-- Skill Selection -->
                <div class="mb-3">
                    <label for="skill-select" class="form-label">2. 選擇相關知識點</label>
                    <select class="form-select" id="skill-select" name="skill_id">
                        <option value="" selected>-- 請選擇 --</option>
                        {% for skill in skills %}
                            <option value="{{ skill.skill_id }}">{{ skill.skill_ch_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Notes -->
                <div class="mb-3">
                    <label for="notes-textarea" class="form-label">3. 新增筆記或心得</label>
                    <textarea class="form-control" id="notes-textarea" name="notes" rows="4" placeholder="例如：忘記公式、計算錯誤..."></textarea>
                </div>
                
                <!-- Submit Button -->
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">儲存錯題</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('add-mistake-form');
    const imageInput = document.getElementById('image-upload-input');
    const imagePathInput = document.getElementById('exam_image_path');
    const preview = document.getElementById('image-preview');
    const uploadStatus = document.getElementById('upload-status');
    const submitBtn = form.querySelector('button[type="submit"]');

    // Handle image selection and upload
    imageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            // Display preview
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(file);

            // Upload the file immediately
            uploadStatus.textContent = '正在上傳圖片...';
            submitBtn.disabled = true;
            const formData = new FormData();
            formData.append('file', file);

            fetch('/mistake-notebook/upload-image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadStatus.textContent = '圖片上傳成功！';
                    uploadStatus.className = 'form-text text-success';
                    imagePathInput.value = data.path; // Store the returned path
                    submitBtn.disabled = false;
                } else {
                    uploadStatus.textContent = `上傳失敗: ${data.message}`;
                    uploadStatus.className = 'form-text text-danger';
                    submitBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                uploadStatus.textContent = '上傳發生錯誤，請檢查網路連線。';
                uploadStatus.className = 'form-text text-danger';
                submitBtn.disabled = true;
            });
        }
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const skillId = document.getElementById('skill-select').value;
        const notes = document.getElementById('notes-textarea').value;
        const imagePath = imagePathInput.value;

        if (!skillId) {
            alert('請選擇一個相關知識點！');
            return;
        }

        const data = {
            exam_image_path: imagePath,
            skill_id: skillId,
            notes: notes,
            question_data: null // This can be extended in the future
        };

        fetch('/mistake-notebook/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('錯題已成功新增！');
                window.location.href = "{{ url_for('core.mistake_notebook') }}";
            } else {
                alert(`儲存失敗: ${result.message}`);
            }
        })
        .catch(error => {
            console.error('Submit error:', error);
            alert('儲存時發生錯誤，請稍後再試。');
        });
    });
});
</script>
{% endblock %}
