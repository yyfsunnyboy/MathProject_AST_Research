<!--
=============================================================================
æ¨¡çµ„åç¨± (Module Name): templates/teacher_dashboard.html
åŠŸèƒ½èªªæ˜ (Description): æ•™å¸«ç®¡ç†å„€è¡¨æ¿
å¾Œç«¯å‘¼å« (Backend Call): app.py -> teacher_dashboard
ç‰ˆæœ¬è³‡è¨Š (Version): V2.0
æ›´æ–°æ—¥æœŸ (Date): 2026-01-13
ç¶­è­·åœ˜éšŠ (Maintainer): Math AI Project Team
=============================================================================
-->
<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>æ•™å¸«å„€è¡¨æ¿ - è‡ªé©æ‡‰æ€§æ•™å­¸ç³»çµ±</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6f9;
        }

        .navbar {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h1 {
            margin: 0;
            font-size: 1.5em;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            margin-left: 15px;
            font-size: 0.9em;
        }

        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .welcome-banner {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 20px;
            background: #ecf0f1;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .stat-box:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <h1>è‡ªé©æ‡‰æ€§æ•™å­¸ç³»çµ± - æ•™å¸«ç«¯</h1>
        <div>
            <a href="{{ url_for('dashboard') }}"
                style="background-color: #3498db; padding: 5px 10px; border-radius: 4px; margin-right: 10px;">
                ğŸ‘€ åˆ‡æ›è‡³å­¸ç”Ÿæ¨¡å¼
            </a>
            <span>æ­¡è¿, {{ username }} è€å¸«</span>
            <a href="{{ url_for('logout') }}">ç™»å‡º</a>
        </div>
    </div>

    <div class="container">
        <div class="welcome-banner">
            <h2>æ­¡è¿å›ä¾†ï¼</h2>
            <p>é€™æ˜¯æ‚¨çš„æ•™å­¸ç®¡ç†ä¸­å¿ƒã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸‹æ–¹çš„ç®¡ç†åŠŸèƒ½ä¾†ç®¡ç†èª²ç¨‹ã€æŠ€èƒ½èˆ‡è³‡æ–™åº«ã€‚</p>
        </div>

        <div class="card">
            <h3>å¿«é€Ÿæ¦‚è¦½</h3>
            <div class="grid">
                <div class="stat-box">
                    <div class="stat-number">0</div>
                    <div class="stat-label">ç­ç´šæ•¸</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">0</div>
                    <div class="stat-label">å­¸ç”Ÿç¸½æ•¸</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">0</div>
                    <div class="stat-label">å¾…æ‰¹æ”¹ä½œæ¥­</div>
                </div>
            </div>
        </div>

        <!-- ç­ç´šç®¡ç†å€å¡Š -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>ç­ç´šç®¡ç†</h3>
                <button onclick="openCreateClassModal()"
                    style="background-color: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    + å»ºç«‹æ–°ç­ç´š
                </button>
            </div>
            <div id="classList" class="grid">
                <!-- ç­ç´šåˆ—è¡¨å°‡é€é JavaScript å‹•æ…‹è¼‰å…¥ -->
                <p style="color: #7f8c8d;">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <div class="card">
            <h3>ç®¡ç†åŠŸèƒ½</h3>
            <div class="grid">
                <a href="{{ url_for('core.admin_curriculum') }}" style="text-decoration: none;">
                    <div class="stat-box"
                        style="cursor: pointer; background: linear-gradient(135deg, #3498db, #2980b9); color: white;">
                        <div style="font-size: 2em;">ğŸ“š</div>
                        <div style="margin-top: 10px; font-weight: bold;">èª²ç¨‹åˆ†é¡ç®¡ç†</div>
                    </div>
                </a>
                <a href="{{ url_for('core.admin_skills') }}" style="text-decoration: none;">
                    <div class="stat-box"
                        style="cursor: pointer; background: linear-gradient(135deg, #f1c40f, #f39c12); color: white;">
                        <div style="font-size: 2em;">âš™ï¸</div>
                        <div style="margin-top: 10px; font-weight: bold;">å–®å…ƒç®¡ç†</div>
                    </div>
                </a>
                <a href="{{ url_for('core.admin_examples') }}" style="text-decoration: none;">
                    <div class="stat-box"
                        style="cursor: pointer; background: linear-gradient(135deg, #00b894, #00cec9); color: white;">
                        <div style="font-size: 2em;">ğŸ“–</div>
                        <div style="margin-top: 10px; font-weight: bold;">ä¾‹é¡Œç®¡ç†</div>
                    </div>
                </a>
                <a href="{{ url_for('core.admin_prerequisites') }}" style="text-decoration: none;">
                    <div class="stat-box"
                        style="cursor: pointer; background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white;">
                        <div style="font-size: 2em;">ğŸ”—</div>
                        <div style="margin-top: 10px; font-weight: bold;">æŠ€èƒ½é—œè¯</div>
                    </div>
                </a>
                <a href="{{ url_for('core.db_maintenance') }}" style="text-decoration: none;">
                    <div class="stat-box"
                        style="cursor: pointer; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;">
                        <div style="font-size: 2em;">ğŸ—ƒï¸</div>
                        <div style="margin-top: 10px; font-weight: bold;">è³‡æ–™åº«ç®¡ç†</div>
                    </div>
                </a>
                <a href="{{ url_for('core.admin_textbook_importer') }}" style="text-decoration: none;">
                    <div class="stat-box"
                        style="cursor: pointer; background: linear-gradient(135deg, #e67e22, #d35400); color: white;">
                        <div style="font-size: 2em;">ğŸ¤–</div>
                        <div style="margin-top: 10px; font-weight: bold;">AI æ•™æåŒ¯å…¥</div>
                    </div>
                </a>
                <a href="{{ url_for('teacher_analysis') }}" style="text-decoration: none;">
                    <div class="stat-box"
                        style="cursor: pointer; background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white;">
                        <div style="font-size: 2em;">ğŸ“Š</div>
                        <div style="margin-top: 10px; font-weight: bold;">å­¸ç”Ÿåˆ†æå ±å‘Š</div>
                    </div>
                </a>
                <a href="{{ url_for('core.ai_prompt_settings_page') }}" style="text-decoration: none;">
                    <div class="stat-box"
                        style="cursor: pointer; background: linear-gradient(135deg, #16a085, #1abc9c); color: white;">
                        <div style="font-size: 2em;">ğŸ¤–</div>
                        <div style="margin-top: 10px; font-weight: bold;">AI åƒæ•¸è¨­å®š</div>
                    </div>
                </a>
            </div>
        </div>
    </div>
    </div>

    <!-- ç®¡ç†å­¸ç”Ÿ Modal -->
    <div id="studentModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div
            style="background-color: white; padding: 30px; border-radius: 8px; width: 600px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="studentModalTitle" style="margin: 0;">ç®¡ç†å­¸ç”Ÿ</h3>
                <button onclick="closeStudentModal()"
                    style="background: none; border: none; font-size: 1.5em; cursor: pointer;">&times;</button>
            </div>

            <div style="background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <h4 style="margin-top: 0;">æ–°å¢å­¸ç”Ÿ</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="newStudentUsername" placeholder="å¸³è™Ÿ" style="flex: 1; padding: 8px;">
                    <input type="text" id="newStudentPassword" placeholder="å¯†ç¢¼" style="flex: 1; padding: 8px;">
                    <button onclick="addStudent()"
                        style="background-color: #2ecc71; color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer;">æ–°å¢</button>
                </div>

                <div style="border-top: 1px dashed #ccc; padding-top: 15px;">
                    <h4 style="margin-top: 0; font-size: 0.9em; color: #555;">æ‰¹æ¬¡æ–°å¢ (Excel)</h4>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="studentExcelFile" accept=".xlsx, .xls" style="flex: 1;">
                        <button onclick="uploadStudentExcel()"
                            style="background-color: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer;">ä¸Šå‚³
                            Excel</button>
                    </div>
                    <p style="font-size: 0.8em; color: #7f8c8d; margin: 5px 0 0 0;">æ ¼å¼ï¼šç¬¬ä¸€æ¬„ç‚ºå¸³è™Ÿï¼Œç¬¬äºŒæ¬„ç‚ºå¯†ç¢¼ (è‡ªå‹•ç•¥éæ¨™é¡Œåˆ—)</p>
                </div>
            </div>

            <h4>å­¸ç”Ÿåˆ—è¡¨</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #ecf0f1;">
                        <th style="padding: 10px; text-align: left;">å¸³è™Ÿ</th>
                        <th style="padding: 10px; text-align: left;">å»ºç«‹æ—¥æœŸ</th>
                    </tr>
                </thead>
                <tbody id="studentListBody">
                    <!-- å­¸ç”Ÿåˆ—è¡¨å°‡å‹•æ…‹è¼‰å…¥ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- å»ºç«‹ç­ç´š Modal -->
    <div id="createClassModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div style="background-color: white; padding: 30px; border-radius: 8px; width: 400px;">
            <h3>å»ºç«‹æ–°ç­ç´š</h3>
            <input type="text" id="newClassName" placeholder="è«‹è¼¸å…¥ç­ç´šåç¨± (ä¾‹å¦‚ï¼šé«˜ä¸€æ•¸å­¸Aç­)"
                style="width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box;">
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="closeCreateClassModal()"
                    style="background-color: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">å–æ¶ˆ</button>
                <button onclick="createClass()"
                    style="background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <script>
        // é é¢è¼‰å…¥æ™‚ç²å–ç­ç´šåˆ—è¡¨
        document.addEventListener('DOMContentLoaded', loadClasses);

        function openCreateClassModal() {
            document.getElementById('createClassModal').style.display = 'flex';
        }

        function closeCreateClassModal() {
            document.getElementById('createClassModal').style.display = 'none';
            document.getElementById('newClassName').value = '';
        }

        async function loadClasses() {
            try {
                const response = await fetch("{{ url_for('core.get_teacher_classes') }}");
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('classList');
                    if (data.classes.length === 0) {
                        container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #7f8c8d;">ç›®å‰é‚„æ²’æœ‰ç­ç´šï¼Œè«‹é»æ“Šå³ä¸Šè§’å»ºç«‹ï¼</p>';
                        return;
                    }

                    container.innerHTML = data.classes.map(cls => `
                        <div class="stat-box" style="text-align: left; position: relative;">
                            <div style="font-size: 1.2em; font-weight: bold; color: #2c3e50;">${cls.name}</div>
                            <div style="margin-top: 10px; color: #7f8c8d; display: flex; align-items: center; gap: 5px;">
                                <span>ç­ç´šä»£ç¢¼ï¼š</span>
                                <span id="code-${cls.id}" style="background-color: #f1c40f; color: #fff; padding: 2px 5px; border-radius: 3px; font-weight: bold;">
                                    ${cls.class_code}
                                </span>
                                <button onclick="copyCode('${cls.class_code}')" title="è¤‡è£½é‚€è«‹ç¢¼" style="background: none; border: none; cursor: pointer; font-size: 1em;">ğŸ“‹</button>
                                <button onclick="regenerateCode(${cls.id})" title="ç”¢ç”Ÿæ–°ä»£ç¢¼" style="background: none; border: none; cursor: pointer; font-size: 1em;">ğŸ”„</button>
                            </div>
                            <div style="margin-top: 5px; color: #7f8c8d;">å­¸ç”Ÿäººæ•¸ï¼š${cls.student_count} äºº</div>
                            <div style="margin-top: 15px;">
                                <button onclick="openStudentModal(${cls.id}, '${cls.name}')" style="background-color: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.9em;">ç®¡ç†å­¸ç”Ÿ</button>
                            </div>
                            <button onclick="deleteClass(${cls.id})" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #e74c3c; cursor: pointer;" title="åˆªé™¤ç­ç´š">ğŸ—‘ï¸</button>
                        </div>
                    `).join('');

                    // æ›´æ–°æ¦‚è¦½æ•¸æ“š
                    document.querySelector('.stat-number').textContent = data.classes.length;
                }
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function createClass() {
            const name = document.getElementById('newClassName').value.trim();
            if (!name) {
                alert('è«‹è¼¸å…¥ç­ç´šåç¨±');
                return;
            }

            try {
                const response = await fetch("{{ url_for('core.create_class') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: name })
                });
                const data = await response.json();

                if (data.success) {
                    closeCreateClassModal();
                    loadClasses(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                } else {
                    alert(data.message || 'å»ºç«‹å¤±æ•—');
                }
            } catch (error) {
                console.error('Error creating class:', error);
                alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('é‚€è«‹ç¢¼å·²è¤‡è£½ï¼');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
            });
        }

        async function regenerateCode(classId) {
            if (!confirm('ç¢ºå®šè¦ç”¢ç”Ÿæ–°çš„é‚€è«‹ç¢¼å—ï¼ŸèˆŠçš„ä»£ç¢¼å°‡æœƒå¤±æ•ˆã€‚')) {
                return;
            }
            try {
                const url = "{{ url_for('core.regenerate_class_code', class_id=0) }}".replace('0', classId);
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const data = await response.json();
                if (data.success) {
                    const codeSpan = document.getElementById(`code-${classId}`);
                    if (codeSpan) {
                        codeSpan.textContent = data.new_code;
                        // Also update the copy button's onclick handler if necessary, though in this structure it's not needed
                        alert('æ–°çš„é‚€è«‹ç¢¼å·²ç”¢ç”Ÿï¼');
                        loadClasses(); // Easiest way to refresh all data including copy button onclick
                    }
                } else {
                    alert(data.message || 'ç”¢ç”Ÿæ–°ç¢¼å¤±æ•—');
                }
            } catch (error) {
                console.error('Error regenerating code:', error);
                alert('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }


        let currentClassId = null;

        function openStudentModal(classId, className) {
            currentClassId = classId;
            document.getElementById('studentModalTitle').textContent = `ç®¡ç†å­¸ç”Ÿ - ${className}`;
            document.getElementById('studentModal').style.display = 'flex';
            loadClassStudents(classId);
        }

        function closeStudentModal() {
            document.getElementById('studentModal').style.display = 'none';
            document.getElementById('newStudentUsername').value = '';
            document.getElementById('newStudentPassword').value = '';
            currentClassId = null;
        }

        async function loadClassStudents(classId) {
            const tbody = document.getElementById('studentListBody');
            tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 20px;">è¼‰å…¥ä¸­...</td></tr>';

            try {
                const url = "{{ url_for('core.get_class_students', class_id=0) }}".replace('0', classId);
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    if (data.students.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 20px; color: #7f8c8d;">ç›®å‰æ²’æœ‰å­¸ç”Ÿ</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.students.map(s => `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 10px;">${s.username}</td>
                            <td style="padding: 10px;">${s.created_at}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = `<tr><td colspan="2" style="text-align: center; color: red;">${data.message}</td></tr>`;
                }
            } catch (error) {
                console.error('Error loading students:', error);
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: red;">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        async function addStudent() {
            if (!currentClassId) return;

            const usernameInput = document.getElementById('newStudentUsername');
            const passwordInput = document.getElementById('newStudentPassword');
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                alert('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼');
                return;
            }

            try {
                const url = "{{ url_for('core.add_student_to_class', class_id=0) }}".replace('0', currentClassId);
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (data.success) {
                    alert('å­¸ç”Ÿæ–°å¢æˆåŠŸï¼');
                    usernameInput.value = '';
                    passwordInput.value = '';
                    loadClassStudents(currentClassId); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                    loadClasses(); // æ›´æ–°ç­ç´šäººæ•¸
                } else {
                    alert(data.message || 'æ–°å¢å¤±æ•—');
                }
            } catch (error) {
                console.error('Error adding student:', error);
                alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function uploadStudentExcel() {
            if (!currentClassId) return;

            const fileInput = document.getElementById('studentExcelFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('è«‹é¸æ“‡ Excel æª”æ¡ˆ');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            // Show loading state
            const btn = document.querySelector('button[onclick="uploadStudentExcel()"]');
            const originalText = btn ? btn.textContent : 'ä¸Šå‚³ Excel';
            if (btn) {
                btn.textContent = 'è™•ç†ä¸­...';
                btn.disabled = true;
            }

            try {
                const url = "{{ url_for('core.upload_students_excel', class_id=0) }}".replace('0', currentClassId);

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    fileInput.value = ''; // Clear input
                    loadClassStudents(currentClassId); // Reload list
                    loadClasses(); // Update counts
                } else {
                    alert(data.message || 'ä¸Šå‚³å¤±æ•—');
                }
            } catch (error) {
                console.error('Error uploading Excel:', error);
                alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                if (btn) {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }
        }

        async function deleteClass(classId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç­ç´šå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) return;

            try {
                // å»ºæ§‹åˆªé™¤ URL
                const deleteUrl = "{{ url_for('core.delete_class', class_id=0) }}".replace('0', classId);

                const response = await fetch(deleteUrl, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    loadClasses(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                } else {
                    alert(data.message || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                console.error('Error deleting class:', error);
                alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
    </script>
</body>

</html>