<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>PDF 練習題</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #333; }
        #question-area { margin-top: 20px; padding: 15px; background: #e9f5ff; border-radius: 5px; }
        #answer-input { width: 100%; padding: 10px; margin-top: 10px; border-radius: 4px; border: 1px solid #ccc; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-top: 10px; }
        .btn-submit { background-color: #28a745; color: white; }
        .btn-next { background-color: #007bff; color: white; }
        #result-area { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .result-correct { background-color: #d4edda; color: #155724; }
        .result-incorrect { background-color: #f8d7da; color: #721c24; }
        .hidden { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h2>從 PDF 產生的練習題</h2>
        <a href="{{ url_for('dashboard') }}">返回儀表板</a>
        <hr>

        <div id="question-container">
            <div id="loader" class="loader"></div>
            <div id="question-area" class="hidden">
                <p id="question-text"></p>
                <div id="options-area"></div>
                <textarea id="answer-input" rows="4" placeholder="請在此輸入您的答案..."></textarea>
            </div>
            <button id="submit-btn" class="btn btn-submit hidden">提交答案</button>
        </div>

        <div id="result-area" class="hidden">
            <h4>批改結果</h4>
            <p id="result-text"></p>
            <p><strong>Gemini-Flash 評估:</strong> <span id="flash-eval"></span></p>
            <p><strong>Gemini-Pro 評估:</strong> <span id="pro-eval"></span></p>
            <p><strong>參考答案:</strong> <span id="correct-answer"></span></p>
        </div>

        <button id="next-btn" class="btn btn-next hidden">下一題</button>
    </div>

    <script>
        const questionType = "{{ question_type }}";
        let currentQuestion = null;
        let originalAnswer = null;

        const loader = document.getElementById('loader');
        const questionArea = document.getElementById('question-area');
        const questionText = document.getElementById('question-text');
        const optionsArea = document.getElementById('options-area');
        const answerInput = document.getElementById('answer-input');
        const submitBtn = document.getElementById('submit-btn');
        const resultArea = document.getElementById('result-area');
        const resultText = document.getElementById('result-text');
        const flashEvalText = document.getElementById('flash-eval');
        const proEvalText = document.getElementById('pro-eval');
        const correctAnswerText = document.getElementById('correct-answer');
        const nextBtn = document.getElementById('next-btn');

        async function getNewQuestion() {
            showLoader(true);
            resultArea.classList.add('hidden');
            nextBtn.classList.add('hidden');
            submitBtn.classList.remove('hidden');
            answerInput.value = '';

            const response = await fetch("{{ url_for('pdf.generate_pdf_question') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });
            const data = await response.json();
            
            if (data.error) {
                alert(data.error);
                showLoader(false);
                return;
            }

            try {
                const questionData = JSON.parse(data);
                currentQuestion = questionData.question;
                originalAnswer = questionData.answer;

                questionText.innerText = currentQuestion;
                optionsArea.innerHTML = '';

                if (questionType === 'multiple_choice' && questionData.options) {
                    answerInput.classList.add('hidden');
                    questionData.options.forEach(option => {
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'option';
                        radio.value = option;
                        radio.id = `option-${option}`;
                        const label = document.createElement('label');
                        label.htmlFor = `option-${option}`;
                        label.innerText = option;
                        optionsArea.appendChild(radio);
                        optionsArea.appendChild(label);
                        optionsArea.appendChild(document.createElement('br'));
                    });
                } else {
                    answerInput.classList.remove('hidden');
                }

                showLoader(false);

            } catch (e) {
                alert('無法解析題目格式，正在重試...');
                console.error("Error parsing question JSON:", e);
                console.log("Received data:", data);
                getNewQuestion(); // Retry
            }
        }

        async function checkAnswer() {
            let userAnswer;
            if (questionType === 'multiple_choice') {
                const selectedOption = document.querySelector('input[name="option"]:checked');
                if (!selectedOption) {
                    alert('請選擇一個選項');
                    return;
                }
                userAnswer = selectedOption.value;
            } else {
                userAnswer = answerInput.value;
                if (!userAnswer.trim()) {
                    alert('請輸入答案');
                    return;
                }
            }

            showLoader(true);

            const response = await fetch("{{ url_for('pdf.check_pdf_answer') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: currentQuestion,
                    user_answer: userAnswer,
                    original_answer: originalAnswer
                })
            });
            const data = await response.json();

            if (data.error) {
                alert(data.error);
                showLoader(false);
                return;
            }
            
            try {
                const flashEval = JSON.parse(data.flash_eval);
                const proEval = JSON.parse(data.pro_eval);

                // Determine final correctness (e.g., require Pro model to be correct)
                const isCorrect = proEval.is_correct;

                resultText.innerText = isCorrect ? "恭喜你，回答正確！" : "再試一次，或參考下面的解釋。";
                resultArea.className = isCorrect ? 'result-correct' : 'result-incorrect';
                
                flashEvalText.innerText = flashEval.feedback;
                proEvalText.innerText = proEval.feedback;
                correctAnswerText.innerText = data.final_answer;

                resultArea.classList.remove('hidden');
                submitBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');

            } catch(e) {
                alert('無法解析批改結果。');
                console.error("Error parsing evaluation JSON:", e);
                console.log("Received data:", data);
            } finally {
                showLoader(false);
            }
        }

        function showLoader(show) {
            if (show) {
                loader.classList.remove('hidden');
                questionArea.classList.add('hidden');
                submitBtn.classList.add('hidden');
            } else {
                loader.classList.add('hidden');
                questionArea.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
            }
        }

        submitBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', getNewQuestion);

        // Load the first question
        document.addEventListener('DOMContentLoaded', getNewQuestion);
    </script>
</body>
</html>
