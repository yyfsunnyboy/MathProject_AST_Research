<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²ç¨‹åˆ†é¡ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- â˜…â˜…â˜… è¤‡è£½ admin_skills.html çš„æ¨£å¼ â˜…â˜…â˜… -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .navbar { background: #2c3e50; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .navbar .logo { font-weight: bold; font-size: 1.3em; }
        .navbar a { color: #ecf0f1; text-decoration: none; padding: 8px 15px; border-radius: 4px; transition: background 0.2s; margin-left: 10px; }
        .navbar a:hover { background: #34495e; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: #2c3e50; }
        .btn-add { background: #27ae60; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; transition: background 0.2s; }
        .btn-add:hover { background: #229954; }
        .alert { padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; border: 1px solid transparent; }
        .alert-success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .alert-danger { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .filter-bar { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .data-table { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #34495e; color: white; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef; }
        tbody tr:hover { background: #f8f9fa; }
        .btn-group { display: flex; gap: 8px; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
        .btn-edit { background: #3498db; color: white; }
        .btn-edit:hover { background: #2980b9; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn-delete:hover { background: #c0392b; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); animation: fadeIn 0.3s; overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: white; margin: 50px auto; padding: 25px 30px; width: 90%; max-width: 600px; border-radius: 10px; box-shadow: 0 5px 30px rgba(0,0,0,0.3); animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #2c3e50; }
        .close { font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; transition: color 0.2s; }
        .close:hover { color: #000; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 6px; color: #2c3e50; font-weight: 600; font-size: 0.95em; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group select { width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 5px; font-size: 0.95em; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52,152,219,0.1); }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }
        .btn-submit { background: #27ae60; color: white; padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background 0.2s; }
        .btn-submit:hover { background: #229954; }
        .btn-cancel { background: #95a5a6; color: white; padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background 0.2s; }
        .btn-cancel:hover { background: #7f8c8d; }
    </style>
</head>
<body>
    <!-- â˜…â˜…â˜… 1. çµ±ä¸€ Navbar â˜…â˜…â˜… -->
    <div class="navbar">
        <div class="logo">ğŸ“ åŠŸæ–‡æ•¸å­¸ - èª²ç¨‹åˆ†é¡ç®¡ç†</div>
        <div>
            <a href="{{ url_for('dashboard') }}">è¿”å›å„€è¡¨æ¿</a>
            <a href="{{ url_for('core.admin_skills') }}">å–®å…ƒç®¡ç†</a>
            <a href="{{ url_for('logout') }}">ç™»å‡º</a>
        </div>
    </div>

    <div class="container">
        <!-- â˜…â˜…â˜… 2. çµ±ä¸€ Header â˜…â˜…â˜… -->
        <div class="header">
            <h1>èª²ç¨‹åˆ†é¡ç®¡ç†</h1>
            <div>
                <button class="btn-add" onclick="openModal('add')">
                    â• æ–°å¢èª²ç¨‹åˆ†é¡
                </button>
            </div>
        </div>

        <!-- â˜…â˜…â˜… 3. çµ±ä¸€ Filter Bar â˜…â˜…â˜… -->
        <div class="filter-bar">
            <form id="filterForm" method="GET" action="{{ url_for('core.admin_curriculum') }}" class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label for="f_curriculum" class="form-label">èª²ç¶±</label>
                    <select id="f_curriculum" name="f_curriculum" class="form-select">
                        <option value="">å…¨éƒ¨</option>
                        {% for c in filters.curriculums %}
                        <option value="{{ c }}" {% if selected_filters.f_curriculum == c %}selected{% endif %}>{{ curriculum_map.get(c, c) }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="f_grade" class="form-label">å¹´ç´š</label>
                    <select id="f_grade" name="f_grade" class="form-select">
                        <option value="">å…¨éƒ¨</option>
                        {% for g in filters.grades %}
                        <option value="{{ g }}" {% if selected_filters.f_grade == g %}selected{% endif %}>{{ grade_map.get(g, g) }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="f_volume" class="form-label">å†Šåˆ¥</label>
                    <select id="f_volume" name="f_volume" class="form-select">
                        <option value="">å…¨éƒ¨</option>
                        {% for v in filters.volumes %}
                        <option value="{{ v }}" {% if selected_filters.f_volume == v %}selected{% endif %}>{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="f_chapter" class="form-label">ç« </label>
                    <select id="f_chapter" name="f_chapter" class="form-select">
                        <option value="">å…¨éƒ¨</option>
                        {% for ch in filters.chapters %}
                        <option value="{{ ch }}" {% if selected_filters.f_chapter == ch %}selected{% endif %}>{{ ch }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">ç¯©é¸</button>
                    <a href="{{ url_for('core.admin_curriculum') }}" class="btn btn-secondary w-100 mt-2">é‡è¨­</a>
                </div>
            </form>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- â˜…â˜…â˜… 4. çµ±ä¸€ Table â˜…â˜…â˜… -->
        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>èª²ç¶±</th>
                        <th>å¹´ç´š</th>
                        <th>å†Šåˆ¥</th>
                        <th>ç« </th>
                        <th>ç¯€</th>
                        <th>æŠ€èƒ½ID</th>
                        <th>æŠ€èƒ½åç¨±</th>
                        <th>é †åº</th>
                        <th>é›£åº¦</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in curriculum %}
                    <tr>
                        <td>{{ curriculum_map.get(item.curriculum, item.curriculum) }}</td>
                        <td>{{ grade_map.get(item.grade, item.grade) }}</td>
                        <td>{{ item.volume }}</td>
                        <td>{{ item.chapter }}</td>
                        <td>{{ item.section }}</td>
                        <td>{{ item.skill_id }}</td>
                        <td>{{ item.skill_info.skill_ch_name if item.skill_info else 'N/A' }}</td>
                        <td>{{ item.display_order }}</td>
                        <td>{{ item.difficulty_level }}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-edit" 
                                        data-item='{{ item.to_dict() | tojson | e }}' 
                                        onclick="openModal('edit', this.dataset.item)">
                                    ç·¨è¼¯</button>
                                <form action="{{ url_for('core.admin_delete_curriculum', curriculum_id=item.id) }}" method="post" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')">
                                    <button type="submit" class="btn btn-delete">åˆªé™¤</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center" style="padding: 40px;">æ²’æœ‰è³‡æ–™</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- â˜…â˜…â˜… 5. çµ±ä¸€ Modal â˜…â˜…â˜… -->
    <div id="formModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="curriculumForm" method="post">
                <div class="row g-3">
                    <div class="form-group col-md-6">
                        <label for="curriculum">èª²ç¶± *</label>
                        <select id="curriculum" name="curriculum" required>
                                    <option value="junior_high">åœ‹æ°‘ä¸­å­¸</option>
                                    <option value="general">æ™®é€šé«˜ä¸­</option>
                                    <option value="vocational">æŠ€è¡“å‹é«˜ä¸­</option>
                                </select>
                            </div>
                    <div class="form-group col-md-6">
                        <label for="grade">å¹´ç´š *</label>
                        <select id="grade" name="grade" required>
                                    <option value="7">åœ‹ä¸€</option>
                                    <option value="8">åœ‹äºŒ</option>
                                    <option value="9">åœ‹ä¸‰</option>
                                    <option value="10">é«˜ä¸€</option>
                                    <option value="11">é«˜äºŒ</option>
                                    <option value="12">é«˜ä¸‰</option>
                                </select>
                            </div>
                    <div class="form-group col-md-6">
                        <label for="volume">å†Šåˆ¥ *</label>
                        <select id="volume" name="volume" required></select>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="chapter">ç«  *</label>
                        <select id="chapter" name="chapter" required></select>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="section">ç¯€ *</label>
                        <select id="section" name="section" required></select>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="paragraph">æ®µ (å¯é¸)</label>
                        <input type="text" id="paragraph" name="paragraph" placeholder="ä¾‹å¦‚ï¼šé‡é»æ•´ç†">
                    </div>
                    <div class="form-group col-12">
                        <label for="skill_id">æŠ€èƒ½ID *</label>
                        <select id="skill_id" name="skill_id" required>
                                    {% for skill in skills %}
                                    <option value="{{ skill.skill_id }}">{{ skill.skill_ch_name }} ({{ skill.skill_id }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                    <div class="form-group col-md-6">
                        <label for="display_order">é¡¯ç¤ºé †åº</label>
                        <input type="number" id="display_order" name="display_order" value="0" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="difficulty_level">é›£åº¦ç­‰ç´š</label>
                        <input type="number" id="difficulty_level" name="difficulty_level" value="1" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-submit">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- â˜…â˜…â˜… 6. çµ±ä¸€ JavaScript â˜…â˜…â˜… -->
    <script>
        const modal = document.getElementById('formModal');
        const modalTitle = document.getElementById('modalTitle');
        const form = document.getElementById('curriculumForm');

        // â˜…â˜…â˜… æ–°å¢ï¼šModal å…§çš„ä¸‹æ‹‰é¸å–®å…ƒç´  â˜…â˜…â˜…
        const modalCurriculumSelect = document.getElementById('curriculum');
        const modalGradeSelect = document.getElementById('grade');
        const modalVolumeSelect = document.getElementById('volume');
        const modalChapterSelect = document.getElementById('chapter');
        const modalSectionSelect = document.getElementById('section');

        function openModal(mode, itemJson) {
            if (mode === 'add') {
                modalTitle.textContent = 'æ–°å¢èª²ç¨‹åˆ†é¡';
                form.action = "{{ url_for('core.admin_add_curriculum') }}";
                form.reset(); // æ¸…ç©ºè¡¨å–®
            } else if (mode === 'edit') {
                const item = JSON.parse(itemJson);
                modalTitle.textContent = 'ç·¨è¼¯èª²ç¨‹åˆ†é¡';
                form.action = "{{ url_for('core.admin_edit_curriculum', curriculum_id=0) }}".replace('0', item.id);
                
                // â˜…â˜…â˜… ä¿®æ”¹ï¼šéåŒæ­¥å¡«å…¥è³‡æ–™ï¼Œä»¥è™•ç†é€£å‹•é¸å–® â˜…â˜…â˜…
                fillModalForm(item);
            }
            modal.style.display = 'block';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // ESC éµé—œé–‰
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // â˜…â˜…â˜… æ–°å¢ï¼šéåŒæ­¥å¡«å…… Modal è¡¨å–®çš„å‡½å¼ â˜…â˜…â˜…
        async function fillModalForm(item) {
            // 1. ç›´æ¥è¨­å®šå›ºå®šé¸é …å’Œè¼¸å…¥æ¡†
            modalCurriculumSelect.value = item.curriculum;
            modalGradeSelect.value = item.grade;
            document.getElementById('paragraph').value = item.paragraph || '';
            document.getElementById('skill_id').value = item.skill_id;
            document.getElementById('display_order').value = item.display_order;
            document.getElementById('difficulty_level').value = item.difficulty_level;

            // 2. æ ¹æ“šèª²ç¶±å’Œå¹´ç´šï¼ŒéåŒæ­¥è¼‰å…¥ã€Œå†Šåˆ¥ã€é¸é …
            await updateModalDropdown(modalVolumeSelect, `/admin/api/curriculum/volumes?curriculum=${item.curriculum}&grade=${item.grade}`, item.volume);

            // 3. æ ¹æ“šå†Šåˆ¥ï¼ŒéåŒæ­¥è¼‰å…¥ã€Œç« ã€é¸é …
            await updateModalDropdown(modalChapterSelect, `/admin/api/curriculum/chapters?curriculum=${item.curriculum}&grade=${item.grade}&volume=${item.volume}`, item.chapter);

            // 4. æ ¹æ“šç« ï¼ŒéåŒæ­¥è¼‰å…¥ã€Œç¯€ã€é¸é …
            await updateModalDropdown(modalSectionSelect, `/admin/api/curriculum/sections?curriculum=${item.curriculum}&grade=${item.grade}&volume=${item.volume}&chapter=${encodeURIComponent(item.chapter)}`, item.section);
        }

        // â˜…â˜…â˜… æ–°å¢ï¼šæ›´æ–° Modal ä¸­ä¸‹æ‹‰é¸å–®çš„é€šç”¨å‡½å¼ â˜…â˜…â˜…
        async function updateModalDropdown(selectElement, url, selectedValue) {
            selectElement.innerHTML = '<option>è¼‰å…¥ä¸­...</option>';
            try {
                const response = await fetch(url);
                const options = await response.json();
                selectElement.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
                options.forEach(opt => {
                    const option = new Option(opt, opt);
                    selectElement.add(option);
                });
                if (selectedValue) {
                    selectElement.value = selectedValue;
                }
            } catch (error) {
                console.error(`Failed to load options for ${selectElement.id}:`, error);
                selectElement.innerHTML = '<option>è¼‰å…¥å¤±æ•—</option>';
            }
        }

        // â˜…â˜…â˜… æ–°å¢ï¼šç‚º Modal å…§çš„ä¸‹æ‹‰é¸å–®ç¶å®šé€£å‹•äº‹ä»¶ â˜…â˜…â˜…
        modalCurriculumSelect.addEventListener('change', () => {
            const curriculum = modalCurriculumSelect.value;
            updateModalDropdown(modalGradeSelect, `/admin/api/curriculum/grades?curriculum=${curriculum}`);
            // æ¸…ç©ºå¾ŒçºŒé¸å–®
            modalVolumeSelect.innerHTML = '';
            modalChapterSelect.innerHTML = '';
            modalSectionSelect.innerHTML = '';
        });

        modalGradeSelect.addEventListener('change', () => {
            const curriculum = modalCurriculumSelect.value;
            const grade = modalGradeSelect.value;
            updateModalDropdown(modalVolumeSelect, `/admin/api/curriculum/volumes?curriculum=${curriculum}&grade=${grade}`);
            // æ¸…ç©ºå¾ŒçºŒé¸å–®
            modalChapterSelect.innerHTML = '';
            modalSectionSelect.innerHTML = '';
        });

        modalVolumeSelect.addEventListener('change', () => {
            const curriculum = modalCurriculumSelect.value;
            const grade = modalGradeSelect.value;
            const volume = modalVolumeSelect.value;
            updateModalDropdown(modalChapterSelect, `/admin/api/curriculum/chapters?curriculum=${curriculum}&grade=${grade}&volume=${volume}`);
            // æ¸…ç©ºå¾ŒçºŒé¸å–®
            modalSectionSelect.innerHTML = '';
        });

        modalChapterSelect.addEventListener('change', () => {
            const curriculum = modalCurriculumSelect.value;
            const grade = modalGradeSelect.value;
            const volume = modalVolumeSelect.value;
            const chapter = modalChapterSelect.value;
            updateModalDropdown(modalSectionSelect, `/admin/api/curriculum/sections?curriculum=${curriculum}&grade=${grade}&volume=${volume}&chapter=${encodeURIComponent(chapter)}`);
        });

        // â˜…â˜…â˜… æ–°å¢ï¼šé€£å‹•ä¸‹æ‹‰é¸å–®çš„ JavaScript â˜…â˜…â˜…
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('filterForm');
            const curriculumSelect = document.getElementById('f_curriculum');
            const gradeSelect = document.getElementById('f_grade');
            const volumeSelect = document.getElementById('f_volume');
            const chapterSelect = document.getElementById('f_chapter');

            function submitForm() {
                form.submit();
            }

            curriculumSelect.addEventListener('change', function() {
                // é¸æ“‡æ–°èª²ç¶±æ™‚ï¼Œæ¸…ç©ºå¾Œé¢çš„é¸é …ä¸¦æäº¤
                gradeSelect.value = '';
                volumeSelect.value = '';
                chapterSelect.value = '';
                submitForm();
            });

            gradeSelect.addEventListener('change', function() {
                // é¸æ“‡æ–°å¹´ç´šæ™‚ï¼Œæ¸…ç©ºå¾Œé¢çš„é¸é …ä¸¦æäº¤
                volumeSelect.value = '';
                chapterSelect.value = '';
                submitForm();
            });

            volumeSelect.addEventListener('change', function() {
                // é¸æ“‡æ–°å†Šåˆ¥æ™‚ï¼Œæ¸…ç©ºå¾Œé¢çš„é¸é …ä¸¦æäº¤
                chapterSelect.value = '';
                submitForm();
            });

            // ç•¶é¸æ“‡ç« ç¯€æ™‚ï¼Œç›´æ¥æäº¤è¡¨å–®
            chapterSelect.addEventListener('change', submitForm);

            // å°‡ Bootstrap çš„ form-select class åŠ åˆ° modal çš„ select å…ƒç´ 
            // è®“å®ƒå€‘çœ‹èµ·ä¾†ä¸€è‡´
            const modalSelects = document.querySelectorAll('#formModal select');
            modalSelects.forEach(select => {
                select.classList.add('form-select');
                select.style.padding = '0.375rem 2.25rem 0.375rem 0.75rem';
            });
            const modalInputs = document.querySelectorAll('#formModal input');
            modalInputs.forEach(input => {
                input.classList.add('form-control');
            });
            const modalLabels = document.querySelectorAll('#formModal label');
            modalLabels.forEach(label => {
                label.classList.add('form-label');
            });
        });
    </script>
</body>
</html>
