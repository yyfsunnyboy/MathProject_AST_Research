{% extends "base.html" %}
<!--
=============================================================================
æ¨¡çµ„åç¨± (Module Name): templates/mistake_notebook.html
åŠŸèƒ½èªªæ˜ (Description): å­¸ç”ŸéŒ¯é¡Œæœ¬
å¾Œç«¯å‘¼å« (Backend Call): core/routes/analysis.py -> mistake_notebook
ç‰ˆæœ¬è³‡è¨Š (Version): V2.0
æ›´æ–°æ—¥æœŸ (Date): 2026-01-13
ç¶­è­·åœ˜éšŠ (Maintainer): Math AI Project Team
=============================================================================
-->

{% block title %}æˆ‘çš„éŒ¯é¡Œæœ¬{% endblock %}

{% block styles %}
<style>
    .container {
        margin-top: 2rem;
    }
    .mistake-card {
        margin-bottom: 1.5rem;
        border: 1px solid #e9ecef;
        border-left-width: 5px;
    }
    .mistake-card-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .mistake-card-body {
        display: flex;
        gap: 1.5rem;
        padding: 1.25rem;
    }
    .mistake-image-container {
        flex: 1;
        min-width: 200px;
    }
    .mistake-image {
        max-width: 100%;
        border-radius: 4px;
        cursor: pointer;
    }
    .mistake-details {
        flex: 2;
    }
    .notes-section {
        background-color: #fffbef;
        border-left: 3px solid #ffc107;
        padding: 10px;
        border-radius: 4px;
        white-space: pre-wrap; /* Preserve whitespace and newlines */
    }
    #loading, #no-entries {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }
    .filter-controls {
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸ“ æˆ‘çš„éŒ¯é¡Œæœ¬</h2>
        <a href="{{ url_for('core.add_mistake_page') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> æ‰‹å‹•æ–°å¢éŒ¯é¡Œ
        </a>
    </div>
    
    <!-- Filter Controls -->
    <div class="filter-controls">
        <label for="skill-filter" class="form-label">ç¯©é¸çŸ¥è­˜é»ï¼š</label>
        <select id="skill-filter" class="form-select w-auto d-inline-block">
            <option value="all">å…¨éƒ¨</option>
        </select>
    </div>

    <!-- Entries Container -->
    <div id="mistake-entries-container">
        <!-- JS will populate this -->
    </div>

    <!-- Loading and Empty State -->
    <div id="loading" class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>è¼‰å…¥ä¸­...</p>
    </div>
    <div id="no-entries" style="display: none;">
        <p>æ‚¨çš„éŒ¯é¡Œæœ¬ç›®å‰æ˜¯ç©ºçš„ï¼Œå¿«å»æ–°å¢ç¬¬ä¸€é¡Œå§ï¼</p>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">æŸ¥çœ‹åœ–ç‰‡</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" class="img-fluid" id="modalImage" alt="éŒ¯é¡Œåœ–ç‰‡">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('mistake-entries-container');
    const loadingDiv = document.getElementById('loading');
    const noEntriesDiv = document.getElementById('no-entries');
    const skillFilter = document.getElementById('skill-filter');
    let allEntries = [];

    function renderEntries(entries) {
        container.innerHTML = '';
        if (entries.length === 0) {
            noEntriesDiv.style.display = 'block';
            return;
        }
        noEntriesDiv.style.display = 'none';

        entries.forEach(entry => {
            const card = document.createElement('div');
            card.className = 'card mistake-card';
            card.style.borderLeftColor = entry.skill ? colorFromString(entry.skill_id) : '#6c757d';

            const imageUrl = entry.exam_image_path ? `{{ url_for('static', filename='') }}${entry.exam_image_path}` : '';
            
            card.innerHTML = `
                <div class="mistake-card-header">
                    <strong>${entry.skill_name || 'æœªåˆ†é¡'}</strong>
                    <small class="text-muted">è¨˜éŒ„æ–¼ï¼š${entry.created_at}</small>
                </div>
                <div class="mistake-card-body">
                    ${imageUrl ? `
                    <div class="mistake-image-container">
                        <img src="${imageUrl}" alt="éŒ¯é¡Œåœ–ç‰‡" class="mistake-image" data-bs-toggle="modal" data-bs-target="#imageModal" data-img-src="${imageUrl}">
                    </div>` : ''}
                    <div class="mistake-details">
                        <h6>ç­†è¨˜èˆ‡å¿ƒå¾—ï¼š</h6>
                        <p class="notes-section">${entry.notes || 'æ²’æœ‰æ–°å¢ç­†è¨˜ã€‚'}</p>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function populateFilter(entries) {
        const skills = new Map();
        entries.forEach(entry => {
            if (entry.skill_id && !skills.has(entry.skill_id)) {
                skills.set(entry.skill_id, entry.skill_name);
            }
        });

        const sortedSkills = [...skills.entries()].sort((a, b) => a[1].localeCompare(b[1]));

        sortedSkills.forEach(([id, name]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = name;
            skillFilter.appendChild(option);
        });
    }

    skillFilter.addEventListener('change', function() {
        const selectedSkill = this.value;
        if (selectedSkill === 'all') {
            renderEntries(allEntries);
        } else {
            const filteredEntries = allEntries.filter(entry => entry.skill_id === selectedSkill);
            renderEntries(filteredEntries);
        }
    });

    fetch('/api/mistake-notebook')
        .then(response => response.json())
        .then(data => {
            allEntries = data;
            loadingDiv.style.display = 'none';
            populateFilter(allEntries);
            renderEntries(allEntries);
        })
        .catch(error => {
            console.error('Error fetching mistake notebook entries:', error);
            loadingDiv.innerHTML = '<p class="text-danger">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
        });

    // Image modal handler
    const imageModal = document.getElementById('imageModal');
    imageModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const imgSrc = button.getAttribute('data-img-src');
        const modalImage = imageModal.querySelector('#modalImage');
        modalImage.src = imgSrc;
    });

    // Helper to generate a color from a string
    function colorFromString(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        let color = '#';
        for (let i = 0; i < 3; i++) {
            let value = (hash >> (i * 8)) & 0xFF;
            // Make colors darker and less saturated
            value = Math.floor(value * 0.6 + 80); 
            color += ('00' + value.toString(16)).substr(-2);
        }
        return color;
    }
});
</script>
{% endblock %}
