<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>AI æ•™æåˆ†æé€²åº¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
        }

        .navbar {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar a {
            color: white;
            text-decoration: none;
        }

        .navbar .logo {
            font-weight: bold;
            font-size: 1.2em;
        }

        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .header {
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
        }

        #log-container {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 6px;
            height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .log-info {
            color: #bdc3c7;
        }

        .log-success {
            color: #2ecc71;
            font-weight: bold;
        }

        .log-error {
            color: #e74c3c;
            font-weight: bold;
        }

        .log-debug {
            color: #9b59b6;
            font-style: italic;
        }

        .status-indicator {
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <a href="{{ url_for('dashboard') }}" class="logo">
            è‡ªé©æ‡‰æ€§æ•™å­¸ç³»çµ± ( æ­¡è¿, <strong>{{ username }}</strong>ï¼ )
        </a>
        <div>
            <a href="{{ url_for('core.admin_textbook_importer') }}"
                style="background: #2ecc71; padding: 8px 15px; border-radius: 4px;">è¿”å›åŒ¯å…¥é é¢</a>
            <a href="{{ url_for('logout') }}">ç™»å‡º</a>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AI æ•™æåˆ†æé€²åº¦</h1>
            <p style="color: #555;">ç³»çµ±æ­£åœ¨å³æ™‚è™•ç†ä¸­ï¼Œè«‹å‹¿é—œé–‰æ­¤é é¢...</p>
        </div>

        <div id="log-container"></div>
        <div id="status-indicator" class="status-indicator">è™•ç†ä¸­...</div>
    </div>

    <script>
        const logContainer = document.getElementById('log-container');
        const statusIndicator = document.getElementById('status-indicator');
        const task_id = "{{ task_id }}";
        // ä½¿ç”¨ Jinja2 å‹•æ…‹ç”Ÿæˆæ­£ç¢ºçš„å¾Œç«¯è·¯å¾‘ï¼Œç„¡è«–æ˜¯å¦æœ‰ /admin å‰ç¶´éƒ½èƒ½å°æ‡‰
        const streamUrl = "{{ url_for('core.importer_stream', task_id=task_id) }}";
        const eventSource = new EventSource(streamUrl);

        eventSource.onmessage = function (event) {
            const message = event.data;

            if (message === "END_OF_STREAM") {
                eventSource.close();
                statusIndicator.textContent = "è™•ç†å®Œæˆï¼";
                statusIndicator.style.color = "#2ecc71";
                return;
            }

            const logEntry = document.createElement('div');
            const [type, ...contentParts] = message.split(': ');
            const content = contentParts.join(': ');
            logEntry.textContent = content;
            logEntry.className = `log-${type.toLowerCase()}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight; // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
        };

        eventSource.onerror = function (err) {
            console.error("EventSource failed:", err);
            statusIndicator.textContent = "é€£ç·šä¸­æ–·ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹ã€‚";
            statusIndicator.style.color = "#e74c3c";
            eventSource.close();
        };
    </script>
</body>

</html>