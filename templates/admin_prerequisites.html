<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç½®æŠ€èƒ½ç®¡ç† - åŠŸæ–‡æ•¸å­¸</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .navbar { background: #2c3e50; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .navbar .logo { font-weight: bold; font-size: 1.3em; }
        .navbar a { color: #ecf0f1; text-decoration: none; padding: 8px 15px; border-radius: 4px; transition: background 0.2s; margin-left: 10px; }
        .navbar a:hover { background: #34495e; }
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: #2c3e50; }
        .alert { padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; border: 1px solid transparent; }
        .alert-success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .alert-danger { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .card { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .card h2 { margin-top: 0; margin-bottom: 10px; color: #34495e; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr 150px; gap: 20px; align-items: flex-end; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .form-group select { width: 100%; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background 0.2s; color: white; }
        .btn-submit { background: #27ae60; }
        .btn-submit:hover { background: #229954; }
        .btn-delete { background: #e74c3c; padding: 6px 12px; font-size: 0.9em; }
        .btn-delete:hover { background: #c0392b; }
        .data-table { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #34495e; color: white; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef; }
        tbody tr:hover { background: #f8f9fa; }
        .arrow { font-size: 1.5em; color: #3498db; font-weight: bold; text-align: center; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
        /* Select2 æ¨£å¼è¦†è“‹ */
        .select2-container .select2-selection--single { height: 40px; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 40px; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 38px; }

        /* Modal æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .close { font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        .close:hover { color: #000; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="logo">ğŸ“ åŠŸæ–‡æ•¸å­¸ - å‰ç½®æŠ€èƒ½ç®¡ç†</div>
        <div>
            <a href="{{ url_for('dashboard') }}">è¿”å›å„€è¡¨æ¿</a>
            <a href="{{ url_for('logout') }}">ç™»å‡º</a>
        </div>
    </div>

    <!-- Container -->
    <div class="container">
        <div class="header">
            <h1>å‰ç½®æŠ€èƒ½é—œè¯ç®¡ç†</h1>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- æ–°å¢é—œè¯ -->
        <div class="card">
            <h2>æŸ¥è©¢å‰ç½®æŠ€èƒ½</h2>
            <p style="margin-bottom: 20px; color: #555;">è«‹å¾ä¸‹æ–¹é¸å–®é¸æ“‡ä¸€å€‹ã€Œç›®å‰æŠ€èƒ½ã€ï¼Œç³»çµ±å°‡è‡ªå‹•åˆ—å‡ºå…¶æ‰€æœ‰éœ€è¦çš„ã€ŒåŸºç¤æŠ€èƒ½ã€ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨æ­¤é é¢æ–°å¢æˆ–åˆªé™¤é—œè¯ã€‚</p>
            <div class="form-grid" style="grid-template-columns: 1fr 2fr auto; gap: 15px;">
                <div class="form-group">
                    <label for="category_filter">1. ç¯©é¸æŠ€èƒ½é¡åˆ¥</label>
                    <select id="category_filter" name="category" class="skill-select">
                        <option value="">æ‰€æœ‰é¡åˆ¥</option>
                        {% for category in all_categories %}
                        <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="skill_id_filter">2. é¸æ“‡ç›®å‰æŠ€èƒ½</label>
                    <select id="skill_id_filter" name="skill_id" class="skill-select" required></select>
                </div>
                <button type="button" class="btn btn-submit" onclick="openAddModal()">æ–°å¢åŸºç¤æŠ€èƒ½</button>
            </div>
        </div>

        <!-- ç¾æœ‰é—œè¯åˆ—è¡¨ -->
        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>ç›®å‰æŠ€èƒ½ ID</th>
                        <th>ç›®å‰æŠ€èƒ½åç¨±</th>
                        <th>åŸºç¤æŠ€èƒ½ ID</th>
                        <th>åŸºç¤æŠ€èƒ½åç¨±</th>
                        <th style="width: 100px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="prerequisites-tbody">
                    <!-- JavaScript å°‡æœƒå‹•æ…‹å¡«å……é€™è£¡ -->
                    <tr>
                        <td colspan="5" class="empty-state">
                            è«‹å¾ä¸Šæ–¹é¸æ“‡ä¸€å€‹ã€Œç›®å‰æŠ€èƒ½ã€ä¾†æŸ¥è©¢å…¶å‰ç½®æŠ€èƒ½ã€‚
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- æ–°å¢é—œè¯ Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ–°å¢åŸºç¤æŠ€èƒ½</h2>
                <span class="close" onclick="closeModal('addModal')">&times;</span>
            </div>
            <form id="addPrereqForm" method="POST" action="{{ url_for('core.admin_add_prerequisite') }}">
                <!-- éš±è—æ¬„ä½ï¼Œç”¨æ–¼æäº¤ç›®å‰æŠ€èƒ½çš„ ID -->
                <input type="hidden" id="modal_skill_id" name="skill_id">

                <div class="form-group" style="margin-bottom: 30px;">
                    <label>ç›®å‰æŠ€èƒ½</label>
                    <p id="modal_skill_ch_name" style="font-size: 1.33em; font-weight: 600; color: #2c3e50; padding-top: 5px;"></p>
                </div>

                <div class="form-group">
                    <label for="modal_category_filter">ç¯©é¸åŸºç¤æŠ€èƒ½é¡åˆ¥</label>
                    <select id="modal_category_filter" class="skill-select">
                        <option value="">æ‰€æœ‰é¡åˆ¥</option>
                        {% for category in all_categories %}
                        <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="modal_prerequisite_id">é¸æ“‡åŸºç¤æŠ€èƒ½</label>
                    <select id="modal_prerequisite_id" name="prerequisite_id" class="skill-select" required>
                        <option></option>
                        {% for skill in all_skills %}
                        <option value="{{ skill.skill_id }}">{{ skill.skill_ch_name }} ({{ skill.skill_id }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn" style="background: #95a5a6;" onclick="closeModal('addModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-submit">ç¢ºå®š</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // ç”¨æ–¼è¨˜ä½ Modal ä¸­çš„é¡åˆ¥é¸æ“‡
            let lastSelectedModalCategory = '';

            // åˆå§‹åŒ– Select2
            $('#category_filter').select2({
                placeholder: "è«‹é¸æ“‡ä¸€å€‹é¡åˆ¥",
                allowClear: true
            });
            $('#skill_id_filter').select2({
                placeholder: "è«‹æœå°‹æˆ–é¸æ“‡ä¸€å€‹æŠ€èƒ½",
                allowClear: true
            });

            // *** ä¿®æ­£ï¼šåœ¨é é¢è¼‰å…¥æ™‚å°±åˆå§‹åŒ– Modal çš„ Select2 ***
            $('#modal_category_filter').select2({ dropdownParent: $('#addModal'), placeholder: "è«‹é¸æ“‡ä¸€å€‹é¡åˆ¥", allowClear: true });
            $('#modal_prerequisite_id').select2({ dropdownParent: $('#addModal'), placeholder: "è«‹æœå°‹æˆ–é¸æ“‡ä¸€å€‹æŠ€èƒ½", allowClear: true });

            // *** ä¿®æ­£ï¼šå°‡ Modal å…§çš„ change äº‹ä»¶ç¶å®šç§»åˆ°å¤–éƒ¨ï¼ŒåªåŸ·è¡Œä¸€æ¬¡ ***
            $('#modal_category_filter').on('change', function() {
                const category = $(this).val();
                lastSelectedModalCategory = category; // è¨˜ä½é¸æ“‡çš„é¡åˆ¥
                const prereqSelect = $('#modal_prerequisite_id');
                
                // æ¸…ç©ºæŠ€èƒ½é¸å–®
                prereqSelect.empty().trigger('change');

                if (category) {
                    fetch(`/admin/api/skills_by_category?category=${category}`)
                        .then(response => response.json())
                        .then(data => {
                            // ä½¿ç”¨æ–°çš„ data æ›´æ–°é¸é …
                            prereqSelect.select2({ data: data, placeholder: "è«‹æœå°‹æˆ–é¸æ“‡ä¸€å€‹æŠ€èƒ½", allowClear: true });
                        });
                }
            });


            // ç•¶é¡åˆ¥æ”¹è®Šæ™‚ï¼Œæ›´æ–°æŠ€èƒ½ä¸‹æ‹‰é¸å–®
            $('#category_filter').on('change', function() {
                const category = $(this).val();
                const skillSelect = $('#skill_id_filter');

                // æ¸…ç©ºæŠ€èƒ½é¸å–®å’Œçµæœè¡¨æ ¼
                skillSelect.empty().trigger('change');
                $('#prerequisites-tbody').html('<tr><td colspan="5" class="empty-state">è«‹å¾ä¸Šæ–¹é¸æ“‡ä¸€å€‹ã€Œç›®å‰æŠ€èƒ½ã€ä¾†æŸ¥è©¢å…¶å‰ç½®æŠ€èƒ½ã€‚</td></tr>');

                fetch(`/admin/api/skills_by_category?category=${category}`)
                    .then(response => response.json())
                    .then(data => {
                        // é è¨­åŠ å…¥ä¸€å€‹ç©ºçš„ placeholder é¸é …
                        if (data.length > 0 && data[0].id !== '') {
                            data.unshift({ id: '', text: '' });
                        }
                        // é‡æ–°å¡«å……é¸é …
                        skillSelect.select2({ data: data, placeholder: "è«‹æœå°‹æˆ–é¸æ“‡ä¸€å€‹æŠ€èƒ½", allowClear: true });
                    });
            });

            $('#skill_id_filter').on('change', function() {
                const skillId = $(this).val();
                const tbody = $('#prerequisites-tbody');

                if (!skillId) {
                    tbody.html(`
                        <tr>
                            <td colspan="5" class="empty-state">
                                è«‹å¾ä¸Šæ–¹é¸æ“‡ä¸€å€‹ã€Œç›®å‰æŠ€èƒ½ã€ä¾†æŸ¥è©¢å…¶å‰ç½®æŠ€èƒ½ã€‚
                            </td>
                        </tr>
                    `);
                    return;
                }

                tbody.html(`
                    <tr>
                        <td colspan="5" class="empty-state">
                            æ­£åœ¨æŸ¥è©¢ä¸­...
                        </td>
                    </tr>
                `);

                fetch(`/admin/api/prerequisites/${skillId}`)
                    .then(response => response.json())
                    .then(data => {
                        tbody.empty(); // æ¸…ç©ºè¡¨æ ¼å…§å®¹
                        if (data.length > 0) {
                            data.forEach(prereq => {
                                const row = `
                                    <tr>
                                        <td><code>${prereq.skill_id}</code></td>
                                        <td><strong>${prereq.skill_ch_name}</strong></td>
                                        <td><code>${prereq.prerequisite_id}</code></td>
                                        <td>${prereq.prerequisite_ch_name}</td>
                                        <td>
                                            <form method="POST" action="/admin/prerequisites/delete/${prereq.prerequisite_record_id}" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é—œè¯å—ï¼Ÿ');">
                                                <button type="submit" class="btn btn-delete">åˆªé™¤</button>
                                            </form>
                                        </td>
                                    </tr>
                                `;
                                tbody.append(row);
                            });
                        } else {
                            tbody.html('<tr><td colspan="5" class="empty-state">æ­¤æŠ€èƒ½æ²’æœ‰è¨­å®šä»»ä½•å‰ç½®æŠ€èƒ½ã€‚</td></tr>');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching prerequisites:', error);
                        tbody.html('<tr><td colspan="5" class="empty-state" style="color: red;">æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨æ—¥èªŒã€‚</td></tr>');
                    });
            });

            // --- Modal ç›¸é—œå‡½å¼ ---
            // å°‡å‡½æ•¸ç¶å®šåˆ° window ç‰©ä»¶ï¼Œä½¿å…¶åœ¨ HTML onclick ä¸­å¯è¦‹
            window.openAddModal = function() {
                const currentSkillId = $('#skill_id_filter').val();
                const currentSkillText = $('#skill_id_filter').select2('data')[0].text;

                if (!currentSkillId) {
                    alert('è«‹å…ˆåœ¨ä¸»é é¢é¸æ“‡ä¸€å€‹ã€Œç›®å‰æŠ€èƒ½ã€ï¼');
                    return;
                }

                // å°‡ç›®å‰æŠ€èƒ½è³‡è¨Šå¡«å…¥ Modal
                $('#modal_skill_id').val(currentSkillId);
                $('#modal_skill_ch_name').text(currentSkillText);

                // *** ä¿®æ­£ï¼šä¸å†é‡æ–°åˆå§‹åŒ–ï¼Œåªè¨­å®šå€¼ä¸¦è§¸ç™¼ change äº‹ä»¶ä¾†è¼‰å…¥é¸é … ***
                $('#modal_category_filter').val(lastSelectedModalCategory).trigger('change'); // æ¢å¾©ä¸Šæ¬¡é¸æ“‡çš„é¡åˆ¥

                // é¡¯ç¤º Modal
                document.getElementById('addModal').style.display = 'block';
            }

            window.closeModal = function(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            // é»æ“Š Modal å¤–éƒ¨å¯é—œé–‰
            window.onclick = function(event) {
                const modal = document.getElementById('addModal');
                if (event.target == modal) {
                    closeModal('addModal');
                }
            }

            // é é¢è¼‰å…¥æ™‚ï¼Œè§¸ç™¼ä¸€æ¬¡é¡åˆ¥ç¯©é¸å™¨çš„ change äº‹ä»¶ä¾†è¼‰å…¥æ‰€æœ‰æŠ€èƒ½
            $('#category_filter').trigger('change');

            // æ–°å¢ï¼šé é¢è¼‰å…¥å¾Œï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å¾å¾Œç«¯å‚³ä¾†çš„ selected_skill_id
            const urlParams = new URLSearchParams(window.location.search);
            const selectedCategoryOnLoad = urlParams.get('category');
            const selectedSkillIdOnLoad = {{ selected_skill_id | tojson | safe }};

            if (selectedCategoryOnLoad) {
                // 1. è¨­å®šä¸¦è§¸ç™¼é¡åˆ¥ç¯©é¸å™¨
                $('#category_filter').val(selectedCategoryOnLoad).trigger('change');

                // 2. ç”±æ–¼ fetch æ˜¯éåŒæ­¥çš„ï¼Œæˆ‘å€‘éœ€è¦ç­‰å¾…æŠ€èƒ½åˆ—è¡¨è¼‰å…¥å¾Œå†è¨­å®š skill_id
                // æˆ‘å€‘å¯ä»¥ç›£è½ select2 çš„ 'select2:data:loaded' äº‹ä»¶ï¼Œä½†æ›´ç°¡å–®çš„æ–¹å¼æ˜¯ä½¿ç”¨ setTimeout
                setTimeout(function() {
                    if (selectedSkillIdOnLoad) {
                        const skillSelect = $('#skill_id_filter');
                        // æª¢æŸ¥é¸é …æ˜¯å¦å·²è¼‰å…¥
                        if (skillSelect.find("option[value='" + selectedSkillIdOnLoad + "']").length) {
                            skillSelect.val(selectedSkillIdOnLoad).trigger('change');
                        } else {
                            // å¦‚æœé¸é …é‚„æ²’è¼‰å…¥ï¼Œæ‰‹å‹•æ·»åŠ å®ƒ
                            // é€™æ˜¯ä¸€å€‹å‚™ç”¨æ–¹æ¡ˆï¼Œæ­£å¸¸æƒ…æ³ä¸‹ fetch æ‡‰è©²èƒ½è¼‰å…¥å®ƒ
                            const newOption = new Option(selectedSkillIdOnLoad, selectedSkillIdOnLoad, true, true);
                            skillSelect.append(newOption).trigger('change');
                        }
                    }
                }, 500); // å»¶é² 500ms ç­‰å¾… AJAX å®Œæˆ
            } else if (selectedSkillIdOnLoad) {
                // å¦‚æœåªæœ‰ skill_idï¼Œå‰‡æŒ‰åŸæ–¹å¼è™•ç†
                $('#skill_id_filter').val(selectedSkillIdOnLoad).trigger('change');
            }
        });
    </script>
</body>
</html>
            }
        }
    </script>
</body>
</html>
</html>



<!--
[PROMPT_SUGGESTION]è«‹ç‚ºã€Œè‡ªå‹•åŒ–å‰ç½®æŠ€èƒ½é—œä¿‚å»ºç«‹æ©Ÿåˆ¶ã€è¨­è¨ˆä¸€å€‹å¾Œç«¯ API å’Œå‰ç«¯æŒ‰éˆ•ã€‚[/PROT_SUGGESTION]
[PROMPT_SUGGESTION]è«‹ç‚ºã€Œå›æº¯èˆ‡å›æ­¸ã€æ©Ÿåˆ¶ç¹ªè£½ä¸€å€‹è©³ç´°çš„æµç¨‹åœ– (Flowchart)ã€‚[/PROT_SUGGESTION]
