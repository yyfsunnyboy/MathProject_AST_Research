# MathMaster 專案詳細功能與技術分析報告

本報告旨在深入解析 MathMaster 專案的系統架構、核心功能、技術實現以及其背後的設計哲學。這是一個為「完全不了解此專案的人」設計的全面指南。

---

## 1. 總體目標與核心功能

MathMaster 是一個**個人化、AI 驅動的數學學習與診斷平台**。其核心目標是透過現代化的技術手段，解決傳統數學學習中的痛點（如練習題有限、缺乏即時回饋、無法因材施教），為學生和老師提供一個高效、互動、且可大規模擴展的教學環境。

- **對學生而言**：它是一個提供無限練習、即時批改、並有 AI 助教隨時提供輔導的學習夥伴。
- **對老師而言**：它是一個強大的教學輔助與內容管理工具，能夠自動化處理教材、分析學生學習狀況，並管理課程體系。

---

## 2. 系統架構與依賴函式庫 (技術棧)

專案採用了以 Python 為核心的現代 Web 開發技術棧，具備處理數據、網頁互動、AI 運算、檔案處理等多重能力。

| 類別 | 函式庫 | 在專案中的作用 |
| :--- | :--- | :--- |
| **Web 框架與後端** | `Flask`, `Flask-Login` | 構建網站的骨幹，處理網頁請求、路由和使用者登入/會話管理。 |
| **資料庫** | `Flask-SQLAlchemy`, `SQLAlchemy` | 作為 ORM (物件關聯對映) 工具，讓程式能以 Python 物件的方式安全、方便地操作資料庫。 |
| **數據處理** | `pandas`, `numpy`, `openpyxl`, `xlsxwriter` | 讀取、處理、操作和寫入 Excel/CSV 檔案，是數據匯入/匯出的核心。 |
| **AI 核心** | `google-generativeai` | 整合 Google Gemini 模型，用於手寫批改、聊天問答、內容分析、學習診斷等所有智慧化功能。 |
| **光學文字辨識(OCR)** | `pytesseract`, `Pillow`, `PyMuPDF` | 從 PDF 或圖片中提取文字。`pytesseract` 是 OCR 引擎，`Pillow` 用於圖像處理，`PyMuPDF` 用於解析 PDF 檔案。 |
| **數據視覺化** | `matplotlib` | 用於繪製圖表，例如學生儀表板的學習分析圖、或自動將數學方程式繪製成圖形。 |
| **開發輔助工具** | `python-dotenv`, `tqdm` | `dotenv` 用於管理環境變數（如 API 金鑰），`tqdm` 在處理長時間任務時顯示進度條。 |

---

## 3. 網站功能與頁面路由詳解

網站功能由 `app.py`（負責基礎驗證和儀表板）和 `core/routes.py`（負責絕大部分核心功能）共同定義，主要分為使用者身份驗證、學生學習介面和教師管理後台三大塊。

### 3.1. 使用者身份驗證 (Authentication)

這些是所有使用者都會接觸到的基礎頁面，定義於 `app.py`。

- **登入 (`/login`)**: 使用者輸入帳號、密碼和**角色（學生/老師）** 進行登入。系統會驗證帳號密碼，並檢查角色是否匹配。
- **註冊 (`/register`)**: 允許新使用者註冊帳號，同樣需要選擇**角色**。
- **登出 (`/logout`)**: 清除使用者登入狀態，並導向回登入頁面。

### 3.2. 學生核心功能 (Student-Facing Features)

這是學生的主要學習區域，提供了互動式練習和 AI 輔助。

- **學生儀表板 (`/dashboard`)**: 學生登入後的主頁面。以課程綱要的結構（冊別 -> 章 -> 節）展示所有知識點，並標示出每個知識點的學習進度。
- **核心練習循環**:
    - **練習頁面 (`/practice/<skill_id>`)**: 針對單一知識點的練習介面。
    - **動態出題 (`/get_next_question`)**: 在頁面中非同步呼叫此 API，後端會動態生成一道新題目。
    - **答案核對 (`/check_answer`)**: 學生提交答案後，由此 API 進行批改並回傳結果。

當您在儀表板點擊一個知識點並開始練習時，系統會遵循以下流程來生成題目：

1.  **前端請求**：您的瀏覽器會向後端發送一個請求，呼叫 `/get_next_question` 這個 API，並附上您點選的技能 ID (例如 `skill_id='gh_SomeSkill'`)。
2.  **後端處理 (`core/routes.py`)**：
    a. 後端收到請求後，會根據您的登入資訊，從 Session 中讀取您當前的課綱情境（例如 `general`，代表「普高」）。
    b. 它會拿著這個「技能 ID」和「課綱」，去查詢 `SkillCurriculum` 資料庫，找出這個技能在當前課綱下設定的**難度等級 (difficulty_level)**。
    c. 接著，程式會動態地載入 `skills/` 資料夾下與技能 ID 同名的 Python 檔案（例如 `skills/gh_SomeSkill.py`）。
    d. 最後，呼叫該檔案中的 `generate(level=...)` 函式，並將從資料庫查到的難度等級傳入。
3.  **技能模組生成題目 (`skills/*.py`)**：
    - `generate()` 函式會根據傳入的難度等級，隨機產生題目參數、計算答案，並將題目文字、答案、AI 提示詞等資訊打包成一個字典 (Dictionary)。
4.  **回傳前端**：後端將這個包含所有題目資訊的字典以 JSON 格式回傳給您的瀏覽器，瀏覽器接收到後便將新題目顯示在畫面上。
- **AI 助教天團**:
    - **AI 手寫批改 (`/analyze_handwriting`)**: 學生可上傳手寫計算過程的**圖片**，AI 會分析其計算步驟是否正確，並以 JSON 格式回傳詳細的批改建議。
    - **AI 聊天輔導 (`/chat_ai`)**: 當學生對題目有疑問時，可透過聊天視窗提問。AI 會根據題目情境進行回答，並提供後續的引導式提問選項。
    - **AI 方程式繪圖 (`/draw_diagram`)**: 若題目包含方程式或不等式，此功能會讓 AI 從題目中提取方程式，並使用 `matplotlib` 繪製出對應的幾何圖形。

### 3.3. 教師/管理員後台功能 (Admin/Teacher Backend)

這部分提供了強大的內容管理和系統維護功能。

- **教師儀表板 (`/teacher_dashboard`, `/teacher/analysis`)**: 教師登入後的主頁，並可查看學生整體的錯題分析、學習診斷報告等。
- **內容管理系統 (CMS)**:
    - **技能管理 (`/skills`)**: 總覽與編輯所有數學知識點（Skill）的詳細資訊。
    - **課綱管理 (`/curriculum`)**: 將技能組織成結構化的課程體系（例如：普高 -> 高一 -> 第一冊 -> 第一章 -> 1-1）。
    - **前置技能管理 (`/admin/prerequisites`)**: 視覺化地設定技能之間的學習依賴關係。
    - **課本例題管理 (`/examples`)**: 管理從課本中匯入的所有例題。
- **自動化與資料庫工具**:
    - **智慧課本匯入器 (`/textbook_importer`)**: 專案的王牌功能。允許上傳 PDF 或整個資料夾的 Word 檔，後端會啟動背景任務，自動進行 OCR 辨識、AI 分析、內容提取，並將課本內容完整地存入資料庫。
    - **資料庫維護 (`/db_maintenance`)**: 提供一站式資料庫管理，包含**一鍵備份**資料庫到 Excel、從備份**還原**、清空資料表等。

---

## 4. 核心模組分析

### 4.1. 資料庫模型層 (`models.py`)

`models.py` 是整個應用的數據基石，它定義了所有業務實體及其關聯。

- **核心實體表**:
    - `User`: 使用者（學生/老師）。
    - `SkillInfo`: **知識點**。儲存每個技能的 ID、中英文名稱、描述、以及專門給 AI 使用的 Prompt。
    - `Class`: 班級。由老師建立。
- **關聯與日誌表 (記錄行為與關係)**:
    - `Progress`: 記錄**哪個使用者**在**哪個技能**上的學習進度。
    - `SkillCurriculum`: 將**技能**對應到**課綱**中的具體位置。
    - `SkillPrerequisites`: 記錄**技能**與**技能**之間的前置依賴關係。
    - `ClassStudent`: 記錄**哪個學生**加入了**哪個班級**。
    - `MistakeLog`: 記錄使用者每一次的**答錯詳情**，包含題目、使用者答案、正確答案和 AI 分析。
    - `ExamAnalysis`: 記錄從上傳的**考卷圖片**中分析出的每一題的診斷結果。
    - `LearningDiagnosis`: 儲存 AI 為學生生成的**學習診斷報告**。
- **內容資產表**:
    - `TextbookExample`: 儲存從課本中自動化匯入的**例題**，與 `SkillInfo` 關聯。

### 4.2. 技能模組層 (`skills/*.py`)

這是專案最具擴充性的設計。`skills/` 目錄下的每一個 `.py` 檔案都代表一個可獨立運作的知識點。

以 `skills/remainder.py`（餘式定理）為例，其標準結構包含：

- **`generate(level)` 函式**:
    - 接收一個難度等級 `level`。
    - 使用 `random` 隨機生成題目參數（如多項式的係數）。
    - 計算出正確答案。
    - 回傳一個 Python 字典，包含 `question_text`（題目文字）、`answer`（答案）、`context_string`（給 AI 看的簡版題目）等結構化資訊。
- **`check(user_answer, correct_answer)` 函式**:
    - 接收學生答案和標準答案。
    - 進行比對，並回傳一個包含 `correct`（是否正確）和 `result`（回饋訊息）的字典。

這種標準化的 `generate`/`check` 介面，使得主程式 `routes.py` 可以輕易地動態載入任何技能模組並使其正常運作。

### 4.3. AI 與自動化處理層

#### `core/ai_analyzer.py`

此模組是專案的「大腦」，封裝了所有與 Google Gemini 的互動。

- **Prompt 管理**: 它為不同任務（手寫批改、聊天、弱點分析）定義了不同的、高度工程化的 Prompt 模板。這些模板會指導 AI 扮演特定角色（如數學助教），並嚴格遵循指定的 JSON 格式進行回覆。
- **多模態能力**: `analyze` 函式展示了其處理多模態（文字+圖片）輸入的能力，它將學生的手寫圖片和題目文字一起傳給 AI 進行綜合分析。
- **功能多樣性**: 提供了多種 AI 應用，包括：
    1.  **手寫批改**: `analyze()`
    2.  **聊天輔導**: `build_chat_prompt()`, `get_chat_response()`
    3.  **學習診斷**: `analyze_student_weakness()`
    4.  **內容生成**: `identify_skills_from_problem()`, `generate_quiz_from_image()`

#### `core/textbook_processor.py`

此模組是專案內容自動化的核心，是一個完整的 ETL (Extract-Transform-Load) 管線。

1.  **Extract (提取)**: `extract_content_from_file` 函式能處理 PDF 和 Word 檔。它綜合使用 `PyMuPDF`（文字提取）、`pytesseract`（圖片文字OCR）、`pypandoc`（Word 轉 Markdown）等多種工具，盡可能地從原始文件中榨取所有文字和圖片內容。
2.  **Transform (轉換)**: `call_gemini_for_analysis` 函式是轉換的核心。它將提取出的雜亂文字，餵給一個針對特定教科書（如龍騰、康軒）設計的超長 Prompt，讓 AI 將其轉換為結構化的 JSON 資料，包含章節、小節、觀念和例題。
3.  **Load (載入)**: `save_to_database` 函式接收 AI 產出的 JSON，遍歷其中的數據，並將其分別寫入 `SkillInfo`, `SkillCurriculum`, `TextbookExample` 等資料表中。
4.  **Code Generation (程式碼生成)**: 作為額外步驟，`auto_generate_skill_code` 能為新發現的技能，自動生成一個 `skills/*.py` 的出題程式碼模板。

---

## 5. 總結

MathMaster 是一個設計精良、技術先進且極具擴展性的教育平台。

其**亮點**在於：
- **高度模組化的技能設計**，讓內容擴充變得簡單。
- **強大的 AI 整合**，不僅用於前端的互動輔導，更在後端實現了驚人的**內容創建自動化**。
- **資料與程式碼分離**的清晰架構，使得課程維護非常靈活。
- **完善的後台管理功能**，為老師和內容管理者提供了極大的便利。

這不僅僅是一個練習題網站，而是一個具備自我成長能力的智慧化教學系統。