# è³‡æ–™åº«æ¬„ä½å°ç…§æª¢æŸ¥å ±å‘Š

**æª¢æŸ¥æ—¥æœŸ**: 2026-01-27  
**æª¢æŸ¥ç›®çš„**: é©—è­‰ `core/prompt_architect.py` èˆ‡ `core/code_generator.py` æ˜¯å¦æ­£ç¢ºç”Ÿæˆ/è¨ˆç®—æ‰€æœ‰è³‡æ–™åº«æ¬„ä½

---

## ğŸ“Š ExperimentLog æ¬„ä½å®Œæ•´å°ç…§è¡¨

### âœ… å·²æ­£ç¢ºè¨˜éŒ„çš„æ¬„ä½ï¼ˆ24 å€‹ï¼‰

| æ¬„ä½åç¨± | è³‡æ–™ä¾†æº | è¨ˆç®—ä½ç½® | ç‹€æ…‹ |
|---------|---------|---------|------|
| `skill_id` | è¼¸å…¥åƒæ•¸ | `log_experiment()` ç›´æ¥å‚³å…¥ | âœ… |
| `start_time` | `time.time()` | `auto_generate_skill_code()` Line 1648 | âœ… |
| `duration_seconds` | `time.time() - start_time` | `log_experiment()` Line 1604 | âœ… |
| `prompt_len` | `len(prompt)` | `auto_generate_skill_code()` Line 2273 | âœ… |
| `code_len` | `len(final_code)` | `auto_generate_skill_code()` Line 2274 | âœ… |
| `is_success` | `is_valid and dyn_ok` | `auto_generate_skill_code()` Line 2235 | âœ… |
| `error_msg` | èªæ³•/é‚è¼¯éŒ¯èª¤è¨Šæ¯ | `validate_python_code()` | âœ… |
| `repaired` | `regex_fixes > 0 or ast_fixes > 0` | `auto_generate_skill_code()` Line 2200 | âœ… |
| `model_name` | `Config.MODEL_ROLES['coder']['model']` | `auto_generate_skill_code()` Line 1649 | âœ… |
| `model_size_class` | `kwargs.get('model_size_class')` | å¾ `competition_benchmark.py` å‚³å…¥ | âœ… |
| `prompt_level` | `kwargs.get('prompt_level')` + Flags | `auto_generate_skill_code()` Line 2261 | âœ… |
| `raw_response` | `response.text` | `auto_generate_skill_code()` Line 1667 | âœ… |
| `final_code` | `CALCULATION_SKELETON + clean_code` | `auto_generate_skill_code()` Line 2184 | âœ… |
| `score_syntax` | `100.0 if success_final else 0.0` | `auto_generate_skill_code()` Line 2296 | âœ… |
| `score_math` | æš«æ™‚å›ºå®š `0.0` | `auto_generate_skill_code()` Line 2299 | âš ï¸ éœ€å¾ŒçºŒå¯¦ä½œ |
| `score_visual` | æš«æ™‚å›ºå®š `0.0` | `auto_generate_skill_code()` Line 2300 | âš ï¸ éœ€å¾ŒçºŒå¯¦ä½œ |
| `healing_duration` | `time.time() - healing_start` | `auto_generate_skill_code()` Line 2007 | âœ… |
| `is_executable` | `1 if success_final else 0` | `auto_generate_skill_code()` Line 2298 | âœ… |
| `ablation_id` | `kwargs.get('ablation_id', 3)` | `auto_generate_skill_code()` Line 1650 | âœ… |
| `missing_imports_fixed` | `', '.join(removed_list)` | `auto_generate_skill_code()` Line 1729 | âœ… |
| `resource_cleanup_flag` | `False` (å›ºå®šå€¼) | `auto_generate_skill_code()` Line 2301 | âœ… |
| `prompt_tokens` | `response.usage_metadata.prompt_token_count` | `auto_generate_skill_code()` Line 1671-1676 | âœ… |
| `completion_tokens` | `response.usage_metadata.candidates_token_count` | `auto_generate_skill_code()` Line 1672 | âœ… |
| `total_tokens` | `prompt_tokens + completion_tokens` | `log_experiment()` Line 1636 | âœ… |

---

### âŒ **ç¼ºå¤±æ¬„ä½ï¼ˆ6 å€‹ï¼‰** - æ–°å¢çš„ 3Ã—3 è¨­è¨ˆå°ˆç”¨æ¬„ä½

| æ¬„ä½åç¨± | é æœŸè³‡æ–™ä¾†æº | ç•¶å‰ç‹€æ…‹ | å½±éŸ¿ç­‰ç´š |
|---------|------------|---------|---------|
| `experiment_group` | å¾ `competition_benchmark.py` å‚³å…¥ ('A1'-'C3') | âŒ **æœªå‚³å…¥** | ğŸ”´ **Critical** |
| `garbage_cleaner_count` | Garbage Cleaner ä¿®å¾©çµ±è¨ˆ | âŒ **æœªçµ±è¨ˆ** | ğŸ”´ **Critical** |
| `eval_eliminator_count` | Eval Eliminator ä¿®å¾©çµ±è¨ˆ | âŒ **æœªçµ±è¨ˆ** | ğŸ”´ **Critical** |
| `sampling_success_count` | Dynamic Sampling æˆåŠŸæ¬¡æ•¸ | âŒ **æœªçµ±è¨ˆ** | ğŸŸ¡ **Medium** |
| `sampling_total_count` | Dynamic Sampling ç¸½æ¬¡æ•¸ | âŒ **æœªçµ±è¨ˆ** | ğŸŸ¡ **Medium** |
| `spec_prompt_id` | MASTER_SPEC çš„ Prompt ID | âŒ **æœªå‚³å…¥** | ğŸŸ¡ **Medium** |
| `use_master_spec` | æ˜¯å¦ä½¿ç”¨ MASTER_SPEC | âŒ **æœªå‚³å…¥** | ğŸŸ¡ **Medium** |

---

### âš ï¸ **çµ±è¨ˆè®Šæ•¸è¿½è¹¤å•é¡Œ**

#### å•é¡Œ 1: `regex_fixes` é‡è¤‡ç´¯åŠ é¢¨éšª

**ä½ç½®**: `auto_generate_skill_code()` Line 1658-2010

**å•é¡Œæè¿°**:
```python
regex_fixes = 0  # Line 1658

# Step A-E: å¤šæ¬¡ç´¯åŠ 
regex_fixes += n  # Line 1716 (ç§»é™¤ Markdown)
regex_fixes += 1  # Line 1724 (æ¸…æ´—ç©ºæ ¼)
regex_fixes += import_removed  # Line 1728
regex_fixes += healer_fixes  # Line 1767
regex_fixes += shadowing_fixes  # Line 1782
regex_fixes += mixed_num_fixes  # Line 1818
regex_fixes += latex_fixes  # Line 1841
regex_fixes += return_fixes  # Line 1877
regex_fixes += var_fixes  # Line 1956
regex_fixes += return_fixes  # Line 1913 (æ³¨æ„ï¼šreturn_fixes è¢«é‡æ–°è³¦å€¼)
regex_fixes += pre_ast_fixes  # Line 1933
regex_fixes += r_fixes  # Line 1939
regex_fixes += qwen_fixes  # Line 2006
```

**é¢¨éšªåˆ†æ**:
- âœ… **æ­£ç¢º**: å„å€‹å­è¨ˆæ•¸å™¨ï¼ˆå¦‚ `latex_fixes`, `qwen_fixes`ï¼‰éƒ½æ˜¯ç¨ç«‹è®Šæ•¸ï¼Œæ²’æœ‰é‡è¤‡è¨ˆç®—
- âš ï¸ **æ½›åœ¨å•é¡Œ**: `return_fixes` åœ¨ Line 1877 å’Œ Line 1913 **å…©æ¬¡ç´¯åŠ **ï¼Œå¯èƒ½é‡è¤‡è¨ˆç®—

**ä¿®æ­£å»ºè­°**:
```python
# Line 1913 æ‡‰æ”¹ç‚ºï¼š
if return_fixes > 0:
    print(...)
    # regex_fixes += return_fixes  # âŒ åˆªé™¤æ­¤è¡Œï¼ˆå·²åœ¨ Line 1877 ç´¯åŠ éï¼‰
```

---

#### å•é¡Œ 2: Garbage Cleaner è¨ˆæ•¸éºå¤±

**é æœŸä½ç½®**: `auto_generate_skill_code()` Step B (æ¸…æ´—ç‰¹æ®Šç©ºæ ¼)

**ç•¶å‰ä»£ç¢¼** (Line 1719-1724):
```python
# Step B: æ¸…æ´—ç‰¹æ®Šç©ºæ ¼
original_len = len(clean_code)
clean_code = clean_code.replace('\xa0', ' ').replace('ã€€', ' ').strip()
if len(clean_code) != original_len:
    regex_fixes += 1
```

**å•é¡Œ**: 
- æ­¤æ­¥é©Ÿç›¸ç•¶æ–¼ **Garbage Cleaner**ï¼ˆç§»é™¤å­¤ç«‹å­—å…ƒï¼‰
- ä½† **æ²’æœ‰ç¨ç«‹è¨ˆæ•¸å™¨** `garbage_cleaner_count`
- ç›®å‰åªç´¯åŠ åˆ° `regex_fixes`ï¼Œç„¡æ³•å–®ç¨çµ±è¨ˆ

**ä¿®æ­£æ–¹æ¡ˆ**:
```python
# Step B: æ¸…æ´—ç‰¹æ®Šç©ºæ ¼ (Garbage Cleaner)
garbage_cleaner_count = 0
original_len = len(clean_code)
clean_code = clean_code.replace('\xa0', ' ').replace('ã€€', ' ').strip()
if len(clean_code) != original_len:
    garbage_cleaner_count = 1
    regex_fixes += 1

# ... åœ¨ log_experiment() æ™‚å‚³å…¥
garbage_cleaner_count=garbage_cleaner_count
```

---

#### å•é¡Œ 3: Eval Eliminator è¨ˆæ•¸éºå¤±

**é æœŸä½ç½®**: `auto_generate_skill_code()` Step F.5 (Pre-AST èªæ³•æ¸…æ´—)

**ç•¶å‰ä»£ç¢¼** (Line 1920-1927):
```python
# Fix 1: ä¿®å¾© eval(calc_string) â†’ safe_eval(calc_string)
clean_code, n = re.subn(
    r'\beval\s*\(',
    r'safe_eval(',
    clean_code
)
pre_ast_fixes += n
if n > 0:
    print(f"ğŸ”§ [{skill_id}] è½‰æ› eval() â†’ safe_eval() ({n} è™•)")
```

**å•é¡Œ**:
- æ­¤æ­¥é©Ÿæ˜¯ **Eval Eliminator**ï¼ˆæ””æˆªå±éšªå‡½æ•¸ï¼‰
- ä½†åªç´¯åŠ åˆ° `pre_ast_fixes`ï¼Œæ²’æœ‰ç¨ç«‹è¨ˆæ•¸å™¨

**ä¿®æ­£æ–¹æ¡ˆ**:
```python
# Fix 1: Eval Eliminator
eval_eliminator_count = 0
clean_code, n = re.subn(r'\beval\s*\(', r'safe_eval(', clean_code)
eval_eliminator_count = n
pre_ast_fixes += n

# ... åœ¨ log_experiment() æ™‚å‚³å…¥
eval_eliminator_count=eval_eliminator_count
```

---

#### å•é¡Œ 4: Dynamic Sampling è¨ˆæ•¸éºå¤±

**é æœŸä½ç½®**: `auto_generate_skill_code()` Line 2239-2256 (å‹•æ…‹æ¡æ¨£)

**ç•¶å‰ä»£ç¢¼**:
```python
# âœ… [Performance Fix V9.2.1] æ—©æœŸé€€å‡ºæ©Ÿåˆ¶
success_count = 0
for sample_idx in range(3):
    try:
        item = temp_module.generate()
        # ... é©—è­‰é‚è¼¯ ...
        success_count += 1
        
        # âœ… æ—©æœŸé€€å‡ºï¼šå¦‚æœå‰ 2 æ¬¡éƒ½æˆåŠŸï¼Œç›´æ¥é€šé
        if success_count >= 2:
            print(f"âœ… [{skill_id}] Dynamic sampling early pass (2/2 successful)")
            break
    except Exception as e:
        error_msg = f"Dynamic sampling failed at iteration {sample_idx+1}: {str(e)}"
        dyn_ok = False
        print(f"[WARN] {error_msg}")
        break
```

**å•é¡Œ**:
- `success_count` å’Œ `sample_idx` éƒ½æ˜¯**å±€éƒ¨è®Šæ•¸**
- ç„¡æ³•åœ¨å¤–éƒ¨è¨ªå•ï¼Œç„¡æ³•è¨˜éŒ„åˆ°è³‡æ–™åº«

**ä¿®æ­£æ–¹æ¡ˆ**:
```python
# Dynamic Sampling: ç²¾ç°¡ç‰ˆï¼ˆ3æ¬¡è¶³å¤ ï¼Œä½†å¯æå‰é€€å‡ºï¼‰
dyn_ok = True
sampling_success_count = 0
sampling_total_count = 0

if is_valid:
    import importlib.util
    try:
        # ... æ¨¡çµ„è¼‰å…¥ ...
        
        for sample_idx in range(3):
            sampling_total_count += 1
            try:
                item = temp_module.generate()
                # ... é©—è­‰é‚è¼¯ ...
                sampling_success_count += 1
                
                if sampling_success_count >= 2:
                    print(f"âœ… [{skill_id}] Dynamic sampling early pass (2/2 successful)")
                    break
            except Exception as e:
                error_msg = f"Dynamic sampling failed at iteration {sample_idx+1}: {str(e)}"
                dyn_ok = False
                print(f"[WARN] {error_msg}")
                break
    except Exception as e:
        dyn_ok = False
        print(f"[WARN] Dynamic sampling error (gating activated): {str(e)}")

# ... åœ¨ log_experiment() æ™‚å‚³å…¥
sampling_success_count=sampling_success_count,
sampling_total_count=sampling_total_count
```

---

## ğŸ”§ `prompt_architect.py` æª¢æŸ¥çµæœ

### `generate_v15_spec()` å‡½æ•¸åˆ†æ

**ä½ç½®**: Line 356-421

**å›å‚³å€¼**:
```python
return {'success': True, 'spec': spec_content}
```

**è³‡æ–™åº«æ“ä½œ**:
```python
new_prompt_entry = SkillGenCodePrompt(
    skill_id=skill_id,
    prompt_content=spec_content,
    prompt_type="MASTER_SPEC",
    system_prompt=ARCHITECT_SYSTEM_PROMPT, 
    user_prompt_template=user_prompt,
    model_tag=model_tag,
    created_at=datetime.now()
)
db.session.add(new_prompt_entry)
db.session.commit()
```

### âŒ ç¼ºå¤±é …ç›®

1. **æœªå›å‚³ `prompt_id`**:
   - ç•¶å‰å›å‚³: `{'success': True, 'spec': spec_content}`
   - éœ€è¦æ”¹ç‚º: `{'success': True, 'spec': spec_content, 'prompt_id': new_prompt_entry.id}`

2. **æœªè¨˜éŒ„ Token æ¶ˆè€—**:
   - `SkillGenCodePrompt` è¡¨æœ‰ `creation_prompt_tokens` ç­‰æ¬„ä½
   - ä½† `generate_v15_spec()` **æ²’æœ‰è¨˜éŒ„** Architect çš„ Token ä½¿ç”¨é‡

3. **æœªè¨˜éŒ„ `experiment_group`**:
   - `SkillGenCodePrompt` è¡¨å·²æœ‰ `experiment_group` æ¬„ä½ï¼ˆLine 333ï¼‰
   - ä½† `generate_v15_spec()` **æ²’æœ‰è¨­å®šæ­¤æ¬„ä½**

---

## ğŸ“‹ ä¿®æ­£æ¸…å–®

### ğŸ”´ Criticalï¼ˆå¿…é ˆä¿®å¾©ï¼‰

1. **æ–°å¢ `garbage_cleaner_count` è¨ˆæ•¸å™¨**
   - ä½ç½®: `code_generator.py` Line 1719-1724
   - å‹•ä½œ: æ–°å¢ç¨ç«‹è¨ˆæ•¸å™¨ï¼Œå‚³å…¥ `log_experiment()`

2. **æ–°å¢ `eval_eliminator_count` è¨ˆæ•¸å™¨**
   - ä½ç½®: `code_generator.py` Line 1920-1927
   - å‹•ä½œ: æ–°å¢ç¨ç«‹è¨ˆæ•¸å™¨ï¼Œå‚³å…¥ `log_experiment()`

3. **å‚³å…¥ `experiment_group` åˆ° `log_experiment()`**
   - ä½ç½®: `competition_benchmark.py` `_save_experiment_log()`
   - å‹•ä½œ: å¾ `group_name` å–å¾—å¯¦é©—çµ„æ¨™è¨˜

4. **æ›´æ–° `log_experiment()` SQL èªå¥**
   - ä½ç½®: `code_generator.py` Line 1607-1618
   - å‹•ä½œ: æ–°å¢ 7 å€‹æ¬„ä½åˆ° INSERT èªå¥

### ğŸŸ¡ Mediumï¼ˆå»ºè­°ä¿®å¾©ï¼‰

5. **æ–°å¢ `sampling_success_count` å’Œ `sampling_total_count`**
   - ä½ç½®: `code_generator.py` Line 2239-2256
   - å‹•ä½œ: æå‡è®Šæ•¸ä½œç”¨åŸŸï¼Œè¨˜éŒ„åˆ°è³‡æ–™åº«

6. **ä¿®å¾© `return_fixes` é‡è¤‡ç´¯åŠ **
   - ä½ç½®: `code_generator.py` Line 1913
   - å‹•ä½œ: ç§»é™¤é‡è¤‡çš„ `regex_fixes += return_fixes`

7. **`generate_v15_spec()` å›å‚³ `prompt_id`**
   - ä½ç½®: `prompt_architect.py` Line 412
   - å‹•ä½œ: æ”¹ç‚º `return {'success': True, 'spec': spec_content, 'prompt_id': new_prompt_entry.id}`

8. **è¨˜éŒ„ Architect Token æ¶ˆè€—**
   - ä½ç½®: `prompt_architect.py` Line 395-398
   - å‹•ä½œ: æå– `response.usage_metadata`ï¼Œå¯«å…¥ `SkillGenCodePrompt`

### ğŸŸ¢ Lowï¼ˆå¯é¸ï¼‰

9. **å¯¦ä½œ `score_math` é‚è¼¯è©•ä¼°**
   - ç•¶å‰ç‹€æ…‹: å›ºå®š `0.0`
   - å»ºè­°: æ•´åˆå‹•æ…‹æ¡æ¨£çµæœï¼Œè¨ˆç®—é‚è¼¯æ­£ç¢ºç‡

10. **å¯¦ä½œ `score_visual` è©•ä¼°**
    - ç•¶å‰ç‹€æ…‹: å›ºå®š `0.0`
    - å»ºè­°: æ•´åˆ Matplotlib æ¸²æŸ“æª¢æ¸¬

---

## ğŸ“Š çµ±è¨ˆæ–¹æ³•é©—è­‰

### AST ä¿®å¾©è¨ˆæ•¸

**ä½ç½®**: `fix_code_via_ast()` å‡½æ•¸

**ç•¶å‰ä»£ç¢¼** (Line 2010):
```python
clean_code, ast_fixes_count = fix_code_via_ast(clean_code)
ast_fixes += ast_fixes_count
```

**é©—è­‰**: âœ… æ­£ç¢ºï¼Œ`ast_fixes` ç¨ç«‹çµ±è¨ˆï¼Œä¸èˆ‡ `regex_fixes` æ··æ·†

### Regex ä¿®å¾©è¨ˆæ•¸

**ç¸½è¨ˆæ–¹å¼**: ç´¯åŠ æ‰€æœ‰å­æ­¥é©Ÿçš„ä¿®å¾©æ¬¡æ•¸

**å­æ­¥é©Ÿ**:
- Markdown ç§»é™¤ (Line 1716)
- ç©ºæ ¼æ¸…æ´— (Line 1724)
- Import å»é‡ (Line 1728)
- ä¸»å‹•ä¿®å¾© (Line 1767)
- å‡½æ•¸ç§»é™¤ (Line 1782)
- æ··åˆæ•¸å­—ä¸² (Line 1818)
- LaTeX ä¿®å¾© (Line 1841)
- Return ä¿®æ­£ (Line 1877)
- è®Šæ•¸å°é½Š (Line 1956)
- Pre-AST æ¸…æ´— (Line 1933)
- Qwen é€šç”¨ä¿®å¾© (Line 2006)

**é©—è­‰**: âœ… æ­£ç¢ºï¼Œæ‰€æœ‰å­è¨ˆæ•¸å™¨éƒ½æ˜¯ç¨ç«‹è®Šæ•¸

---

## âœ… çµè«–

### å·²æ­£ç¢ºå¯¦ä½œï¼ˆ24/30 æ¬„ä½ï¼‰
- åŸºç¤å¯¦é©—è³‡è¨Šï¼ˆskill_id, start_time, duration_seconds ç­‰ï¼‰
- Token çµ±è¨ˆï¼ˆprompt_tokens, completion_tokens, total_tokensï¼‰
- è³ªé‡è©•ä¼°ï¼ˆis_success, is_executable, score_syntaxï¼‰
- ä¿®å¾©çµ±è¨ˆï¼ˆregex_fixes, ast_fixesï¼‰

### éœ€è¦ä¿®å¾©ï¼ˆ6/30 æ¬„ä½ï¼‰
1. `experiment_group` - å¯¦é©—çµ„æ¨™è¨˜
2. `garbage_cleaner_count` - Garbage Cleaner ä¿®å¾©çµ±è¨ˆ
3. `eval_eliminator_count` - Eval Eliminator ä¿®å¾©çµ±è¨ˆ
4. `sampling_success_count` - Dynamic Sampling æˆåŠŸæ¬¡æ•¸
5. `sampling_total_count` - Dynamic Sampling ç¸½æ¬¡æ•¸
6. `spec_prompt_id` - MASTER_SPEC Prompt ID
7. `use_master_spec` - æ˜¯å¦ä½¿ç”¨ MASTER_SPEC

### çµ±è¨ˆæ­£ç¢ºæ€§
- âœ… å„å€‹ä¿®å¾©è¨ˆæ•¸å™¨ç¨ç«‹ï¼Œç„¡é‡è¤‡è¨ˆç®—
- âš ï¸ `return_fixes` å¯èƒ½åœ¨ Line 1877 å’Œ 1913 é‡è¤‡ç´¯åŠ ï¼ˆéœ€æª¢æŸ¥ï¼‰
- âœ… `regex_fixes` å’Œ `ast_fixes` åˆ†é›¢çµ±è¨ˆæ­£ç¢º

---

**ä¸‹ä¸€æ­¥**: åŸ·è¡Œ Critical ä¿®æ­£ï¼ˆé …ç›® 1-4ï¼‰ï¼Œç¢ºä¿ 3Ã—3 å¯¦é©—æ•¸æ“šå®Œæ•´è¨˜éŒ„
