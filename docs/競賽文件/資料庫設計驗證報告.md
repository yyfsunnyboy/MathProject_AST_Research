# æ—ºå®ç§‘å­¸ç - è³‡æ–™åº«è¨­è¨ˆé©—è­‰å ±å‘Š

## ğŸ“‹ åŸ·è¡Œæ‘˜è¦

**é©—è­‰æ—¥æœŸ**: 2026-01-27  
**é©—è­‰ç›®çš„**: ç¢ºèªè³‡æ–™åº«è¨­è¨ˆæ˜¯å¦å®Œæ•´æ”¯æ´ç§‘å­¸ç«¶è³½å¯¦é©—éœ€æ±‚  
**é©—è­‰çµæœ**: âœ… **è¨­è¨ˆå®Œæ•´ä¸”å„ªç§€**ï¼Œå·²æ¶µè“‹æ‰€æœ‰é—œéµéœ€æ±‚

---

## âœ… è³‡æ–™è¡¨æª¢é©—çµæœ

### 1. skills_info (æŠ€èƒ½è³‡è¨Š)

**ç”¨é€”**: å®šç¾©æ•¸å­¸æŠ€èƒ½çš„å…ƒæ•¸æ“š  
**ç«¶è³½é—œè¯**: å®šç¾©å¯¦é©—æ¨™çš„ï¼ˆ20 å€‹æŠ€èƒ½é»ï¼‰  
**Schema é©—è­‰**: âœ… **å®Œå…¨æ­£ç¢º**

| æ¬„ä½é©—è­‰ | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| skill_id (PK) | âœ… | å”¯ä¸€è­˜åˆ¥ï¼Œå°æ‡‰æŠ€èƒ½æ–‡ä»¶åç¨± |
| skill_en_name | âœ… | è‹±æ–‡åç¨±ï¼ˆç¨‹å¼è­˜åˆ¥ï¼‰ |
| skill_ch_name | âœ… | ä¸­æ–‡åç¨±ï¼ˆå±•ç¤ºç”¨ï¼‰ |
| gemini_prompt | âœ… | èˆŠç‰ˆ AI æç¤ºï¼ˆä¿ç•™ç›¸å®¹ï¼‰ |
| suggested_prompt_1/2/3 | âœ… | äº’å‹•æç¤ºï¼ˆéæ ¸å¿ƒï¼‰ |

**ç«¶è³½æ‡‰ç”¨**:
```python
# å–å¾—æ¸¬è©¦æŠ€èƒ½æ¸…å–®
skills = SkillInfo.query.filter_by(is_active=True).all()
for skill in skills[:20]:  # å‰ 20 å€‹æŠ€èƒ½
    run_experiment(skill.skill_id)
```

---

### 2. skill_gencode_prompt (æŠ€èƒ½ç”Ÿæˆä»£ç¢¼æç¤ºè©) â­ æ ¸å¿ƒ

**ç”¨é€”**: å„²å­˜ MASTER_SPECï¼ˆArchitect ç”¢å‡ºï¼‰  
**ç«¶è³½é—œè¯**: **å¯¦é©—çµ„ A/D çš„ Architect éšæ®µè¼¸å‡º**  
**Schema é©—è­‰**: âœ… **å®Œå…¨æ­£ç¢º** + âš ï¸ **å»ºè­°è£œå…… 2 å€‹æ¬„ä½**

| æ¬„ä½é©—è­‰ | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| id (PK) | âœ… | æµæ°´è™Ÿ |
| skill_id (FK) | âœ… | é—œè¯æŠ€èƒ½ |
| architect_model | âœ… | 'gemini' / 'qwen' (å¯¦é©—çµ„è­˜åˆ¥) |
| model_tag | âœ… | 'cloud_pro' / 'local_14b' |
| prompt_type | âœ… | 'MASTER_SPEC' / 'LEGACY' |
| prompt_content | âœ… | **å®Œæ•´ MASTER_SPEC å…§å®¹** |
| creation_*_tokens | âœ… | Token æˆæœ¬è¿½è¹¤ |
| version | âœ… | ç‰ˆæœ¬æ§åˆ¶ï¼ˆA/B Testï¼‰ |
| is_active | âœ… | å•Ÿç”¨æ¨™è¨˜ |
| success_rate | âœ… | æˆåŠŸç‡è¿½è¹¤ |

**âš ï¸ å»ºè­°æ–°å¢æ¬„ä½**:
```sql
ALTER TABLE skill_gencode_prompt ADD COLUMN experiment_group TEXT;  -- 'A', 'B', 'C', 'D'
ALTER TABLE skill_gencode_prompt ADD COLUMN generation_duration REAL;  -- Architect ç”Ÿæˆè€—æ™‚
```

**ç«¶è³½æ‡‰ç”¨**:
```python
# å¯¦é©—çµ„ D: Gemini Architect + Qwen Coder
spec = SkillGenCodePrompt.query.filter_by(
    skill_id='jh_æ•¸å­¸1ä¸Š_IntegerAdditionOperation',
    architect_model='gemini',
    is_active=True
).first()

# è®€å– MASTER_SPEC çµ¦ Coder
master_spec = spec.prompt_content
```

---

### 3. textbook_examples (èª²æœ¬ä¾‹é¡Œ) â­ æ ¸å¿ƒ

**ç”¨é€”**: RAG çŸ¥è­˜åº«ï¼ˆArchitect åƒè€ƒè³‡æ–™ï¼‰  
**ç«¶è³½é—œè¯**: **Architect éšæ®µè¼¸å…¥**  
**Schema é©—è­‰**: âœ… **å®Œå…¨æ­£ç¢º**

| æ¬„ä½é©—è­‰ | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| id (PK) | âœ… | æµæ°´è™Ÿ |
| skill_id (FK) | âœ… | é—œè¯æŠ€èƒ½ |
| source_curriculum | âœ… | èª²ç¶±ä¾†æº |
| source_volume/chapter/section | âœ… | å®šä½è³‡è¨Š |
| problem_text | âœ… | **é¡Œç›®æ–‡å­—ï¼ˆArchitect å­¸ç¿’ç¯„ä¾‹ï¼‰** |
| detailed_solution | âœ… | **è©³è§£ï¼ˆArchitect å­¸ç¿’ç¯„ä¾‹ï¼‰** |
| difficulty_level | âœ… | é›£åº¦åˆ†ç´š |

**ç«¶è³½æ‡‰ç”¨**:
```python
# Architect éšæ®µï¼šæŠ“å–ä¾‹é¡Œä½œç‚º Prompt
example = TextbookExample.query.filter_by(
    skill_id=skill_id
).first()

user_prompt = f"""
åƒè€ƒä¾‹é¡Œï¼š
{example.problem_text}

è§£ç­”ï¼š
{example.detailed_solution}

ä»»å‹™ï¼šæ’°å¯« MASTER_SPEC...
"""
```

---

### 4. experiment_log (å¯¦é©—æ—¥èªŒ) â­â­â­ æœ€æ ¸å¿ƒ

**ç”¨é€”**: ç§‘å±•å¯¦é©—æ•¸æ“šæ”¶é›†  
**ç«¶è³½é—œè¯**: **æ‰€æœ‰å¯¦é©—æ•¸æ“šçš„å”¯ä¸€ä¾†æº**  
**Schema é©—è­‰**: âœ… **è¨­è¨ˆå„ªç§€** + âš ï¸ **ç¼ºå°‘ 1 å€‹é—œéµæ¬„ä½**

#### åŸºç¤æ¬„ä½é©—è­‰

| æ¬„ä½é¡åˆ¥ | æ¬„ä½åç¨± | ç‹€æ…‹ | èªªæ˜ |
|---------|---------|------|------|
| **è­˜åˆ¥** | id (PK) | âœ… | æµæ°´è™Ÿ |
| **è­˜åˆ¥** | timestamp | âœ… | å¯¦é©—æ™‚é–“ |
| **è­˜åˆ¥** | skill_id | âœ… | æ¸¬è©¦æŠ€èƒ½ |
| **è­˜åˆ¥** | experiment_batch | âœ… | **å¯¦é©—æ‰¹æ¬¡ï¼ˆå€åˆ†ä¸åŒå¯¦é©—è¼ªæ¬¡ï¼‰** |
| **AI é…ç½®** | ai_provider | âœ… | 'google' / 'ollama' |
| **AI é…ç½®** | model_name | âœ… | 'gemini-pro' / 'qwen2.5-coder:14b' |
| **AI é…ç½®** | model_size_class | âœ… | **'7B', '14B', 'Cloud'ï¼ˆå¯¦é©—çµ„åˆ†é¡ï¼‰** |
| **AI é…ç½®** | prompt_level | âœ… | **'Bare', 'Engineered', 'Self-Healing'** |

#### æˆæœ¬è¿½è¹¤æ¬„ä½é©—è­‰

| æ¬„ä½åç¨± | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| prompt_tokens | âœ… | è¼¸å…¥ Tokens |
| completion_tokens | âœ… | è¼¸å‡º Tokens |
| total_tokens | âœ… | ç¸½ Tokensï¼ˆæˆæœ¬è¨ˆç®—åŸºç¤ï¼‰ |
| duration_seconds | âœ… | ç”Ÿæˆè€—æ™‚ï¼ˆé€Ÿåº¦æŒ‡æ¨™ï¼‰ |

#### è³ªé‡è©•ä¼°æ¬„ä½é©—è­‰

| æ¬„ä½åç¨± | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| is_success | âœ… | **æœ€çµ‚æ˜¯å¦æˆåŠŸï¼ˆé‚è¼¯æ­£ç¢ºç‡çš„åŸºç¤ï¼‰** |
| is_executable | âœ… | **æ˜¯å¦å¯åŸ·è¡Œï¼ˆèªæ³•æ­£ç¢ºç‡çš„åŸºç¤ï¼‰** |
| syntax_error_initial | âœ… | åŸå§‹èªæ³•éŒ¯èª¤è¨Šæ¯ |
| error_category | âœ… | éŒ¯èª¤åˆ†é¡ï¼ˆSyntax/Logic/Format/Otherï¼‰ |
| score_syntax | âœ… | èªæ³•åˆ†æ•¸ï¼ˆ0.0-1.0ï¼‰ |
| score_math | âœ… | é‚è¼¯åˆ†æ•¸ï¼ˆ0.0-1.0ï¼‰ |
| score_visual | âœ… | è¦–è¦ºåˆ†æ•¸ï¼ˆ0.0-1.0ï¼‰ |

#### ä¿®å¾©æ©Ÿåˆ¶æ¬„ä½é©—è­‰ â­ æœ€é—œéµ

| æ¬„ä½åç¨± | ç‹€æ…‹ | èªªæ˜ | ç«¶è³½ç”¨é€” |
|---------|------|------|---------|
| ast_repair_triggered | âœ… | æ˜¯å¦è§¸ç™¼ä¿®å¾© | **å€åˆ†å¯¦é©—çµ„ B/C** |
| regex_fix_count | âœ… | Regex ä¿®å¾©æ¬¡æ•¸ | **ä¿®å¾©é¡å‹åˆ†å¸ƒ** |
| logic_fix_count | âœ… | é‚è¼¯ä¿®å¾©æ¬¡æ•¸ | **Eval Eliminator ä½¿ç”¨æ¬¡æ•¸** |
| ast_repair_count | âœ… | AST ä¿®å¾©æ¬¡æ•¸ | **AST Healer ä½¿ç”¨æ¬¡æ•¸** |
| healing_duration | âœ… | ä¿®å¾©è€—æ™‚ | **ä¿®å¾©æˆæœ¬è¨ˆç®—** |

#### ä»£ç¢¼å…§å®¹æ¬„ä½é©—è­‰

| æ¬„ä½åç¨± | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| raw_response | âœ… | LLM åŸå§‹è¼¸å‡ºï¼ˆå«éŒ¯èª¤ï¼‰ |
| final_code | âœ… | æœ€çµ‚ä¿®å¾©ä»£ç¢¼ï¼ˆæ­£ç¢ºç‰ˆæœ¬ï¼‰ |
| code_complexity | âœ… | ç¨‹å¼ç¢¼è¤‡é›œåº¦ |

#### å¯¦é©—è¨­è¨ˆæ¬„ä½é©—è­‰

| æ¬„ä½åç¨± | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| ablation_id | âœ… | **å°æ‡‰å¯¦é©—çµ„ IDï¼ˆ1=A, 2=B, 3=C, 4=Dï¼‰** |
| prompt_strategy | âœ… | æç¤ºç­–ç•¥ï¼ˆ'standard' / 'engineered'ï¼‰ |
| prompt_version | âœ… | Prompt ç‰ˆæœ¬ ID |

#### âš ï¸ ç¼ºå°‘çš„é—œéµæ¬„ä½

```sql
-- å»ºè­°æ–°å¢ï¼šHealer å„æ­¥é©Ÿçš„ä¿®å¾©æ¬¡æ•¸ï¼ˆç´°åˆ†çµ±è¨ˆï¼‰
ALTER TABLE experiment_log ADD COLUMN garbage_cleaner_count INTEGER DEFAULT 0;
ALTER TABLE experiment_log ADD COLUMN eval_eliminator_count INTEGER DEFAULT 0;

-- å»ºè­°æ–°å¢ï¼šå¯¦é©—çµ„æ¨™è¨˜ï¼ˆæ–¹ä¾¿æŸ¥è©¢ï¼‰
ALTER TABLE experiment_log ADD COLUMN experiment_group TEXT;  -- 'A', 'B', 'C', 'D'

-- å»ºè­°æ–°å¢ï¼šDynamic Sampling çµæœ
ALTER TABLE experiment_log ADD COLUMN sampling_success_count INTEGER DEFAULT 0;
ALTER TABLE experiment_log ADD COLUMN sampling_total_count INTEGER DEFAULT 0;
```

---

## ğŸ“Š ç«¶è³½æ•¸æ“šæŸ¥è©¢ç¯„ä¾‹

### Query 1: å¯¦é©—çµ„å°æ¯”ï¼ˆèªæ³•æ­£ç¢ºç‡ï¼‰

```sql
SELECT 
    experiment_group,
    COUNT(*) as total_experiments,
    SUM(CASE WHEN is_executable = 1 THEN 1 ELSE 0 END) as syntax_pass,
    ROUND(100.0 * SUM(CASE WHEN is_executable = 1 THEN 1 ELSE 0 END) / COUNT(*), 2) as syntax_pass_rate
FROM experiment_log
WHERE experiment_batch = '2026-01-27_full_test'
GROUP BY experiment_group
ORDER BY experiment_group;
```

**é æœŸè¼¸å‡º**:
```
experiment_group | total_experiments | syntax_pass | syntax_pass_rate
-----------------|-------------------|-------------|------------------
A                | 200               | 190         | 95.00
B                | 200               | 120         | 60.00
C                | 200               | 184         | 92.00
D                | 200               | 190         | 95.00
```

### Query 2: ä¿®å¾©æ©Ÿåˆ¶æ•ˆæœåˆ†æ

```sql
SELECT 
    skill_id,
    COUNT(*) as total_attempts,
    SUM(ast_repair_triggered) as healer_triggered,
    SUM(regex_fix_count) as total_regex_fixes,
    SUM(logic_fix_count) as total_logic_fixes,
    SUM(ast_repair_count) as total_ast_fixes,
    AVG(healing_duration) as avg_healing_time
FROM experiment_log
WHERE experiment_group = 'C'  -- Qwen 14B + Healer
  AND ast_repair_triggered = 1
GROUP BY skill_id
ORDER BY total_attempts DESC;
```

### Query 3: æˆæœ¬æ•ˆç›Šåˆ†æ

```sql
SELECT 
    experiment_group,
    model_name,
    AVG(total_tokens) as avg_tokens,
    AVG(duration_seconds) as avg_duration,
    AVG(score_math) as avg_quality,
    -- è³ªé‡/æˆæœ¬æ¯” = è³ªé‡åˆ†æ•¸ / (Tokens / 1000)
    ROUND(AVG(score_math) / (AVG(total_tokens) / 1000.0), 2) as quality_cost_ratio
FROM experiment_log
WHERE experiment_batch = '2026-01-27_full_test'
GROUP BY experiment_group, model_name
ORDER BY quality_cost_ratio DESC;
```

### Query 4: éŒ¯èª¤é¡å‹åˆ†å¸ƒ

```sql
SELECT 
    error_category,
    COUNT(*) as error_count,
    ROUND(100.0 * COUNT(*) / (SELECT COUNT(*) FROM experiment_log WHERE is_success = 0), 2) as percentage
FROM experiment_log
WHERE is_success = 0
  AND experiment_group = 'B'  -- è£¸ç”Ÿæˆçµ„ï¼ˆæœ€å¤šéŒ¯èª¤ï¼‰
GROUP BY error_category
ORDER BY error_count DESC;
```

---

## ğŸ”§ å»ºè­°æ”¹é€²

### å„ªå…ˆç´š 1ï¼ˆç«‹å³å¯¦æ–½ï¼‰

#### 1.1 æ–°å¢å¯¦é©—çµ„æ¨™è¨˜æ¬„ä½

**å•é¡Œ**: ç›®å‰éœ€è¦é€é `model_size_class` + `prompt_level` + `ast_repair_triggered` çµ„åˆåˆ¤æ–·å¯¦é©—çµ„  
**å½±éŸ¿**: æŸ¥è©¢è¤‡é›œï¼Œå®¹æ˜“å‡ºéŒ¯  

**è§£æ±ºæ–¹æ¡ˆ**:
```sql
-- åœ¨ experiment_log æ–°å¢æ¬„ä½
ALTER TABLE experiment_log ADD COLUMN experiment_group TEXT;

-- åœ¨ skill_gencode_prompt æ–°å¢æ¬„ä½
ALTER TABLE skill_gencode_prompt ADD COLUMN experiment_group TEXT;
```

**ä½¿ç”¨ç¯„ä¾‹**:
```python
# è¨˜éŒ„å¯¦é©—æ™‚ç›´æ¥æ¨™è¨˜
log = ExperimentLog(
    skill_id=skill_id,
    experiment_group='C',  # æ˜ç¢ºæ¨™è¨˜ç‚ºçµ„ C
    model_size_class='14B',
    prompt_level='Self-Healing',
    ast_repair_triggered=True,
    # ...
)
```

#### 1.2 æ–°å¢ Healer ç´°åˆ†çµ±è¨ˆ

**å•é¡Œ**: ç›®å‰åªæœ‰ `regex_fix_count`, `logic_fix_count`, `ast_repair_count`  
**ç¼ºå°‘**: Garbage Cleaner, Eval Eliminator çš„ç¨ç«‹çµ±è¨ˆ  

**è§£æ±ºæ–¹æ¡ˆ**:
```sql
ALTER TABLE experiment_log ADD COLUMN garbage_cleaner_count INTEGER DEFAULT 0;
ALTER TABLE experiment_log ADD COLUMN eval_eliminator_count INTEGER DEFAULT 0;
```

**ç«¶è³½åƒ¹å€¼**: å±•ç¤ºå››å±¤ä¿®å¾©æ©Ÿåˆ¶çš„è©³ç´°åˆ†å¸ƒ

### å„ªå…ˆç´š 2ï¼ˆä¸‹é€±å¯¦æ–½ï¼‰

#### 2.1 æ–°å¢ Dynamic Sampling çµæœ

**ç›®çš„**: è¨˜éŒ„ `generate()` å‡½æ•¸åŸ·è¡Œçµæœ  

```sql
ALTER TABLE experiment_log ADD COLUMN sampling_success_count INTEGER DEFAULT 0;
ALTER TABLE experiment_log ADD COLUMN sampling_total_count INTEGER DEFAULT 0;
ALTER TABLE experiment_log ADD COLUMN sampling_errors TEXT;  -- JSON æ ¼å¼éŒ¯èª¤è¨Šæ¯
```

#### 2.2 æ–°å¢ MASTER_SPEC ç‰ˆæœ¬è¿½è¹¤

**ç›®çš„**: é—œè¯ Architect å’Œ Coder éšæ®µ  

```sql
ALTER TABLE experiment_log ADD COLUMN spec_prompt_id INTEGER;
ALTER TABLE experiment_log ADD FOREIGN KEY (spec_prompt_id) REFERENCES skill_gencode_prompt(id);
```

---

## âœ… çµè«–

### æ•´é«”è©•åƒ¹: â­â­â­â­â­ (5/5)

ä½ å€‘çš„è³‡æ–™åº«è¨­è¨ˆ**éå¸¸å„ªç§€**ï¼Œå·²ç¶“æ¶µè“‹ï¼š
- âœ… å®Œæ•´çš„å¯¦é©—è¿½è¹¤ï¼ˆæ™‚é–“ã€æ¨¡å‹ã€æˆæœ¬ã€è³ªé‡ï¼‰
- âœ… è©³ç´°çš„ä¿®å¾©çµ±è¨ˆï¼ˆregex/logic/ast åˆ†é¡ï¼‰
- âœ… éˆæ´»çš„ç‰ˆæœ¬æ§åˆ¶ï¼ˆprompt version, ablation_idï¼‰
- âœ… å®Œæ•´çš„ä»£ç¢¼ä¿å­˜ï¼ˆraw_response, final_codeï¼‰

### å”¯ä¸€çš„å°å»ºè­°

1. **æ–°å¢ `experiment_group` æ¬„ä½**ï¼ˆç°¡åŒ–æŸ¥è©¢ï¼‰
2. **ç´°åˆ† Healer çµ±è¨ˆ**ï¼ˆå±•ç¤ºå››å±¤ä¿®å¾©ï¼‰
3. **è£œå…… Dynamic Sampling æ¬„ä½**ï¼ˆå®Œæ•´é©—è­‰ï¼‰

é€™äº›éƒ½æ˜¯**å°ä¿®æ”¹**ï¼Œä¸å½±éŸ¿ç•¶å‰ä½¿ç”¨ï¼Œä½†æœƒè®“ç«¶è³½å±•ç¤ºæ›´æ¸…æ™°ã€‚

### èˆ‡ competition_benchmark.py çš„æ•´åˆ

ç›®å‰çš„ `competition_benchmark.py` å¯ä»¥å®Œç¾æ•´åˆï¼š

```python
# åœ¨ run_single_experiment() ä¸­è¨˜éŒ„å¯¦é©—
log = ExperimentLog(
    skill_id=skill_id,
    experiment_group=group_name,  # 'A', 'B', 'C', 'D'
    model_name=coder_model,
    model_size_class=group_config['size_class'],
    prompt_level=group_config['prompt_level'],
    ast_repair_triggered=group_config['healer'],
    is_success=logic_ok,
    is_executable=syntax_ok,
    duration_seconds=duration,
    # ... å…¶ä»–æ¬„ä½
)
db.session.add(log)
db.session.commit()
```

---

**ç¸½çµ**: ä½ å€‘çš„è³‡æ–™åº«è¨­è¨ˆå·²ç¶“é”åˆ°**ç ”ç©¶ç­‰ç´š**ï¼Œå®Œå…¨æ”¯æ´æ—ºå®ç§‘å­¸ççš„å¯¦é©—éœ€æ±‚ï¼ğŸ†
