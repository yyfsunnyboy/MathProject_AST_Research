# 後臺系統分析 - 學生分析報告功能

## 1. 功能概述
本功能旨在提供教師端一個視覺化的分析介面，協助教師快速掌握班級學生的學習狀況與成效。功能位於教師儀表板的管理功能列中，主要包含「常錯題目統計」與「學習診斷報告」兩大區塊。

## 2. 功能詳情

### 2.1 學生常錯題目分析 (Top 10)
- **視覺化呈現**: 使用 Chart.js 函式庫繪製紅色長條圖，直觀顯示錯誤頻率。
- **資料來源**: 資料庫中的 `mistake_logs` 表格。
- **統計邏輯**: 針對所有學生的錯題紀錄，統計相同題目內容 (`question_content`) 出現的次數，並將次數最多的前 10 題依序排列。
- **用途**: 幫助教師識別課程中學生普遍感到困難的題目或觀念，以利後續加強輔導。

### 2.2 學生個別學習診斷報告
- **列表呈現**: 以清晰的表格方式列出所有學生的 AI 學習診斷歷史紀錄。
- **資料來源**: 資料庫中的 `learning_diagnosis` 表格。
- **顯示欄位**:
    - **日期**: 診斷產生的時間。
    - **學生姓名**: 連結 `users` 表格顯示學生帳號/名稱。
    - **系統推薦單元**: AI 根據學生表現推薦加強的單元。
    - **AI 診斷評語**: 針對學生該次表現的詳細文字分析。

## 3. 程式修改內容詳解

### 3.1 後端 (`app.py`)
- **新增路由**: `@app.route('/teacher/analysis')`
- **權限控制**: 加上 `@login_required` 並檢查 `current_user.role` 是否為 'teacher'。
- **資料查詢邏輯**:
    - **錯題統計**: 使用 SQLAlchemy 的 `func.count` 配合 `group_by` 與 `order_by` 進行聚合查詢，取出 Top 10 錯題。
    - **診斷列表**: 透過 `join` 操作關聯 `User` 表格，一次取出診斷資料與對應的學生姓名，並依時間倒序排列。

### 3.2 前端 (`templates/`)
- **`teacher_dashboard.html`**:
    - 在「管理功能」區塊新增「學生分析報告」按鈕 (icon: 📊)，連結至分析頁面。
- **`teacher_analysis.html` (新檔案)**:
    - 引入 `Chart.js` CDN。
    - 實作 Canvas 區塊用於繪製錯題長條圖。
    - 使用 Jinja2 迴圈 (`{% for %}`) 渲染診斷資料表格。
    - 包含 RWD 設計，適應不同螢幕尺寸。

### 3.3 資料庫模型 (`models.py`)
- 本次修改直接使用現有的 `MistakeLog` (錯題紀錄) 與 `LearningDiagnosis` (學習診斷) 模型，未對資料庫結構 (Schema) 進行變更，確保了系統穩定性。

## 4. 測試資料生成
為了驗證功能的正確性，建立了自動化生成腳本 `scripts/seed_analysis_data.py`：
- **檢查/建立學生**: 自動檢查是否存在測試學生帳號，若無則建立。
- **生成錯題紀錄**: 隨機生成 50 筆錯題紀錄，分散在不同的題目與學生上，並模擬特定題目有較高錯誤率。
- **生成診斷紀錄**: 隨機生成 20 筆包含推薦單元與評語的診斷資料，寫入資料庫供介面展示。
