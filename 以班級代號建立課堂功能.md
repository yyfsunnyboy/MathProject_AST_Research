# 以班級代號建立課堂功能實作說明

## 1. 專案目標

本次更新旨在為系統導入一個類似 Google Classroom 的班級邀請碼機制。核心目標是讓教師能夠輕鬆建立班級並透過唯一的邀請碼邀請學生，而學生則可以憑藉此邀請碼自主加入班級。

---

## 2. 功能流程

### 教師端工作流程
1.  **建立班級**：教師在「教師儀表板」點擊「建立新班級」。
2.  **自動生成代碼**：系統後端會自動為新班級產生一組唯一的、由 8 位英數字組成的邀請碼。
3.  **管理與分享代碼**：
    *   教師可以在班級列表上清楚地看到每個班級對應的邀請碼。
    *   提供「📋 複製」按鈕，方便教師一鍵複製邀請碼。
    *   提供「🔄 重新產生」按鈕，在需要時可刷新邀請碼以提高安全性。
    *   教師將邀請碼以口頭或訊息方式提供給學生。

### 學生端工作流程
1.  **取得代碼**：學生從老師那裡獲得班級邀請碼。
2.  **輸入代碼**：學生在自己的「學習儀表板」上，找到「加入班級」功能區塊，輸入邀請碼。
3.  **加入班級**：點擊「加入」按鈕後，系統會驗證邀請碼的有效性。
    *   若驗證成功，系統會自動將學生加入對應的班級。
    *   若代碼無效或學生已在班級中，系統會顯示相應的提示訊息。
4.  **查看班級**：成功加入後，學生的儀表板上「我加入的班級」列表會即時更新，顯示新的班級資訊。

---

## 3. 技術實作細節

為了實現上述功能，我們針對以下五個檔案進行了修改：

### 檔案 1：`models.py` (資料庫模型)

**目的**：處理邀請碼的自動生成與資料庫儲存邏輯。

**修改內容**：
1.  **匯入模組**：在檔案開頭加入了 `secrets` 與 `string` 模組，以產生更高安全性的隨機碼。
2.  **新增代碼生成函式**：
    ```python
    def generate_invitation_code(length=8):
        """產生一個隨機的、由大寫字母和數字組成的邀請碼"""
        alphabet = string.ascii_uppercase + string.digits
        while True:
            code = ''.join(secrets.choice(alphabet) for i in range(length))
            # 確保生成的代碼是唯一的
            if not Class.query.filter_by(class_code=code).first():
                return code
    ```
    這個函式會產生一組 8 位數的代碼，並透過查詢資料庫確保其唯一性，避免重複。

3.  **修改 `Class` 模型**：將 `class_code` 欄位的定義更新，加入 `default` 參數，使其在建立新班級時自動呼叫上述函式。
    ```python
    class Class(db.Model):
        # ...
        class_code = db.Column(db.String(8), unique=True, nullable=False, default=generate_invitation_code)
        # ...
    ```

### 檔案 2：`templates/teacher_dashboard.html` (教師儀表板介面)

**目的**：提供教師管理邀請碼的介面。

**修改內容**：
1.  **新增管理按鈕**：在原本顯示班級代碼的位置，加入了「複製」和「重新產生」的圖示按鈕。
    ```html
    <div style="margin-top: 10px; color: #7f8c8d; display: flex; align-items: center; gap: 5px;">
        <span>班級代碼：</span>
        <span id="code-${cls.id}" style="...">
            ${cls.class_code}
        </span>
        <button onclick="copyCode('${cls.class_code}')" title="複製邀請碼">📋</button>
        <button onclick="regenerateCode(${cls.id})" title="產生新代碼">🔄</button>
    </div>
    ```

2.  **新增 JavaScript 函式**：
    *   `copyCode(code)`：使用 `navigator.clipboard.writeText` API 將邀請碼複製到使用者的剪貼簿。
    *   `regenerateCode(classId)`：此函式會觸發一個對後端的 `POST` 請求，來為指定班級產生新代碼。成功後，它會動態更新頁面上的代碼，無需重新整理頁面。

### 檔案 3：`core/routes.py` (核心後端路由)

**目的**：實作所有班級管理功能的後端商業邏輯。

**修改內容**：
1.  **簡化 `create_class` 路由**：
    *   移除了在 `routes.py` 中本地的 `generate_class_code` 輔助函式。
    *   在建立 `Class` 物件時，不再手動指定 `class_code`，完全依賴 `models.py` 中設定的 `default` 值自動生成。

2.  **新增 `regenerate_class_code` 路由**：
    *   建立了一個新的 `POST` 路由：`/classes/regenerate_code/<int:class_id>`。
    *   此路由會驗證當前使用者是否為該班級的教師，然後呼叫 `models.py` 中的 `generate_invitation_code` 函式產生新碼，更新資料庫，並將新碼透過 JSON 回傳給前端。

3.  **新增 `join_class` 路由**：
    *   建立了一個新的 `POST` 路由：`/class/join`，供學生使用。
    *   此路由負責處理學生提交的表單，它會：
        1.  驗證邀請碼是否存在。
        2.  檢查學生是否已在該班級中。
        3.  若驗證通過，則將學生 (`current_user`) 加入到班級的 `students` 列表中，以建立 `ClassStudent` 關聯。
        4.  透過 `flash` 訊息提供操作回饋（成功、失敗、已加入等）。
        5.  將學生重新導向回儀表板。

### 檔案 4：`app.py` (主應用程式檔案)

**目的**：為學生儀表板準備並傳遞所需的班級資料。

**修改內容**：
1.  **修改 `dashboard` 路由**：
    *   在函式開頭，透過 `current_user.enrolled_classes` 取得當前登入學生所有已加入的班級列表。
    *   將此 `enrolled_classes` 變數傳遞給 `render_template` 函式，讓前端模板可以使用。

### 檔案 5：`templates/dashboard.html` (學生儀表板介面)

**目的**：提供學生加入班級的介面，並顯示他們已加入的班級。

**修改內容**：
1.  **新增「加入班級」卡片**：在頁面頂部加入了一個包含 HTML 表單的卡片，其 `action` 指向新建立的 `/class/join` 路由。
2.  **新增「我加入的班級」卡片**：在旁邊新增了另一個卡片，使用 `for` 迴圈遍歷從 `app.py` 傳入的 `enrolled_classes` 變數，將學生所在的每個班級的名稱與授課教師顯示出來。

---

## 4. 結論

透過以上五個檔案的協同修改，我們成功建立了一套完整、流暢且對使用者友善的班級邀請碼管理系統。此系統不僅功能完整，且在前後端實現上都保持了良好的程式碼結構與安全性。
